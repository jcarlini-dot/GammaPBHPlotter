<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../genindex.html"><link rel="search" title="Search" href="../../search.html">

    <!-- Generated with Sphinx 8.2.3 and Furo 2025.09.25 -->
        <title>gammapbh.cli - GammaPBHPlotter documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=d111a655" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=580074bf" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=8dab3a3b" />
    
    


<style>
  body {
    --color-code-background: #f2f2f2;
  --color-code-foreground: #1e1e1e;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle site navigation sidebar">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc" aria-label="Toggle table of contents sidebar">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <span class="icon"><svg><use href="#svg-menu"></use></svg></span>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">GammaPBHPlotter  documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  <span class="sidebar-brand-text">GammaPBHPlotter  documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../api/index.html">API Reference</a><input aria-label="Toggle navigation of API Reference" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../api/generated/gammapbh.html">gammapbh</a><input aria-label="Toggle navigation of gammapbh" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/generated/gammapbh.cli.html">gammapbh.cli</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../api/generated/gammapbh.cli.html">gammapbh.cli</a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <h1>Source code for gammapbh.cli</h1><div class="highlight"><pre>
<span></span><span class="c1"># src/gammapbh/cli.py</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">GammaPBHPlotter — interactive CLI to analyze and visualize Hawking-radiation</span>
<span class="sd">gamma-ray spectra of primordial black holes (PBHs).</span>

<span class="sd">This module provides:</span>
<span class="sd">  - Monochromatic spectra visualization for selected PBH masses.</span>
<span class="sd">  - Distributed spectra from physically motivated mass PDFs:</span>
<span class="sd">      - Gaussian collapse (Press–Schechter–like).</span>
<span class="sd">      - Non-Gaussian collapse (Biagetti et al. formulation).</span>
<span class="sd">      - Log-normal mass function.</span>
<span class="sd">  - A custom-equation mass PDF tool that lets users enter f(m) directly.</span>
<span class="sd">  - A viewer for previously saved runs (with spectrum overlays and</span>
<span class="sd">    per-selection mass histograms, including analytic/KDE overlays).</span>

<span class="sd">All user-facing plotting is log–log with stable zero-flooring in linear space</span>
<span class="sd">to avoid numerical warnings. Interpolations are performed in (logM, logE) space</span>
<span class="sd">with linear/cubic bivariate splines, and inflight-annihilation tails are</span>
<span class="sd">sanity-trimmed to prevent staircase artifacts in the rightmost bins.</span>

<span class="sd">Conventions</span>
<span class="sd">-----------</span>
<span class="sd">- Masses are in grams [g].</span>
<span class="sd">- Energies are in MeV.</span>
<span class="sd">- Spectra are per energy [MeV^-1 s^-1].</span>
<span class="sd">- “E² dN/dE” overlays are used for SED-style views.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.special</span><span class="w"> </span><span class="kn">import</span> <span class="n">erf</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.interpolate</span><span class="w"> </span><span class="kn">import</span> <span class="n">RectBivariateSpline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.integrate</span><span class="w"> </span><span class="kn">import</span> <span class="n">trapezoid</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">types</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleNamespace</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">colorama</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fore</span><span class="p">,</span> <span class="n">Style</span>

<span class="k">try</span><span class="p">:</span>
    <span class="c1"># works when invoked as `python -m gammapbh.cli` or via installed entry-point</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">__version__</span>  <span class="c1"># type: ignore</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># works when invoked as a plain script `python path/to/cli.py`</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">gammapbh</span><span class="w"> </span><span class="kn">import</span> <span class="n">__version__</span>  <span class="c1"># type: ignore</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;dev&quot;</span>

<div class="viewcode-block" id="pause">
<a class="viewcode-back" href="../../api/generated/gammapbh.cli.html#gammapbh.cli.pause">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">pause</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s2">&quot;Press Enter to continue…&quot;</span><span class="p">):</span>
    <span class="c1"># Only pause if running interactively</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">isatty</span><span class="p">():</span>
        <span class="nb">input</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>


<span class="c1"># … then in view_previous_spectra(), keep your `pause()` calls unchanged.</span>
<span class="c1"># Under pytest (non-tty), pause() becomes a no-op and won’t consume feeder in</span>

<span class="c1"># ---------------------------</span>
<span class="c1"># Matplotlib/NumPy basics</span>
<span class="c1"># ---------------------------</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">})</span>
<span class="c1"># Suppress harmless warnings when we intentionally clamp underflows to ~0</span>
<span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>


<span class="c1"># ---------------------------</span>
<span class="c1"># Paths (package-internal only)</span>
<span class="c1"># ---------------------------</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_resolve_data_dir</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Resolve the *package-internal* data directory that contains BlackHawk tables.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Absolute path to the packaged `blackhawk_data` directory.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - We do not permit user-provided paths here; reproducibility requires the</span>
<span class="sd">      tables bundled with the installed package to be used.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pkg_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">,</span> <span class="s2">&quot;blackhawk_data&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_resolve_results_root</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Resolve the *package-internal* results directory used for all outputs.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Absolute path to the packaged `results` directory.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    RuntimeError</span>
<span class="sd">        If the directory cannot be created or written to.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pkg_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
    <span class="n">dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">,</span> <span class="s2">&quot;results&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># Writability quick check: create and remove a tiny temp file</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">test</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="s2">&quot;.writetest.tmp&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ok&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Results directory is not writable: </span><span class="si">{</span><span class="n">dest</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dest</span>


<span class="n">DATA_DIR</span>     <span class="o">=</span> <span class="n">_resolve_data_dir</span><span class="p">()</span>
<span class="n">RESULTS_DIR</span>  <span class="o">=</span> <span class="n">_resolve_results_root</span><span class="p">()</span>

<span class="n">MONO_RESULTS_DIR</span>   <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">RESULTS_DIR</span><span class="p">,</span> <span class="s2">&quot;monochromatic&quot;</span><span class="p">)</span>
<span class="n">CUSTOM_RESULTS_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">RESULTS_DIR</span><span class="p">,</span> <span class="s2">&quot;custom_equation&quot;</span><span class="p">)</span>
<span class="n">GAUSS_RESULTS_DIR</span>  <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">RESULTS_DIR</span><span class="p">,</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">)</span>
<span class="n">NGAUSS_RESULTS_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">RESULTS_DIR</span><span class="p">,</span> <span class="s2">&quot;non_gaussian&quot;</span><span class="p">)</span>
<span class="n">LOGN_RESULTS_DIR</span>   <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">RESULTS_DIR</span><span class="p">,</span> <span class="s2">&quot;lognormal&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">_d</span> <span class="ow">in</span> <span class="p">(</span><span class="n">MONO_RESULTS_DIR</span><span class="p">,</span> <span class="n">CUSTOM_RESULTS_DIR</span><span class="p">,</span> <span class="n">GAUSS_RESULTS_DIR</span><span class="p">,</span> <span class="n">NGAUSS_RESULTS_DIR</span><span class="p">,</span> <span class="n">LOGN_RESULTS_DIR</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">_d</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="c1"># ---------------------------</span>
<span class="c1"># Labels</span>
<span class="c1"># ---------------------------</span>
<span class="n">GAUSSIAN_METHOD</span>     <span class="o">=</span> <span class="s2">&quot;Gaussian collapse&quot;</span>
<span class="n">NON_GAUSSIAN_METHOD</span> <span class="o">=</span> <span class="s2">&quot;Non-Gaussian Collapse&quot;</span>
<span class="n">LOGNORMAL_METHOD</span>    <span class="o">=</span> <span class="s2">&quot;Log-Normal Distribution&quot;</span>


<span class="c1"># ---------------------------</span>
<span class="c1"># Required files within each mass folder</span>
<span class="c1"># ---------------------------</span>
<span class="n">REQUIRED_FILES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;instantaneous_primary_spectra.txt&quot;</span><span class="p">,</span>
    <span class="s2">&quot;instantaneous_secondary_spectra.txt&quot;</span><span class="p">,</span>
    <span class="s2">&quot;inflight_annihilation_prim.txt&quot;</span><span class="p">,</span>
    <span class="s2">&quot;inflight_annihilation_sec.txt&quot;</span><span class="p">,</span>
    <span class="s2">&quot;final_state_radiation_prim.txt&quot;</span><span class="p">,</span>
    <span class="s2">&quot;final_state_radiation_sec.txt&quot;</span><span class="p">,</span>
<span class="p">]</span>


<span class="c1"># ---------------------------</span>
<span class="c1"># Back navigation support</span>
<span class="c1"># ---------------------------</span>
<div class="viewcode-block" id="BackRequested">
<a class="viewcode-back" href="../../api/generated/gammapbh.cli.html#gammapbh.cli.BackRequested">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">BackRequested</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when the user enters &#39;b&#39; or &#39;back&#39; to return to the prior screen.&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>



<span class="c1"># ---------------------------</span>
<span class="c1"># Discovery helpers</span>
<span class="c1"># ---------------------------</span>
<div class="viewcode-block" id="discover_mass_folders">
<a class="viewcode-back" href="../../api/generated/gammapbh.cli.html#gammapbh.cli.discover_mass_folders">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">discover_mass_folders</span><span class="p">(</span><span class="n">data_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Discover valid mass folders within `data_dir` that contain all required files.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data_dir : str</span>
<span class="sd">        Absolute or relative path to the BlackHawk data directory.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    (list[float], list[str])</span>
<span class="sd">        A pair (masses, names) sorted by mass, where `masses[i]` corresponds to</span>
<span class="sd">        directory name `names[i]`.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Folders are expected to be named as a float mass in grams (e.g., &quot;1.00e+16&quot;).</span>
<span class="sd">    - Only folders containing the full REQUIRED_FILES set are returned.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">masses</span><span class="p">,</span> <span class="n">names</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_dir</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">REQUIRED_FILES</span><span class="p">):</span>
                <span class="n">masses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">);</span> <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">masses</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">masses</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">masses</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">order</span><span class="p">],</span> <span class="p">[</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">order</span><span class="p">]</span></div>



<span class="c1"># ---------------------------</span>
<span class="c1"># CLI + parsing helpers</span>
<span class="c1"># ---------------------------</span>
<div class="viewcode-block" id="info">
<a class="viewcode-back" href="../../api/generated/gammapbh.cli.html#gammapbh.cli.info">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">info</span><span class="p">(</span><span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Print an informational (cyan) line.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">Fore</span><span class="o">.</span><span class="n">CYAN</span> <span class="o">+</span> <span class="s2">&quot;ℹ &quot;</span> <span class="o">+</span> <span class="n">msg</span> <span class="o">+</span> <span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="p">)</span></div>



<div class="viewcode-block" id="warn">
<a class="viewcode-back" href="../../api/generated/gammapbh.cli.html#gammapbh.cli.warn">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Print a warning (yellow) line.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">Fore</span><span class="o">.</span><span class="n">YELLOW</span> <span class="o">+</span> <span class="s2">&quot;⚠ &quot;</span> <span class="o">+</span> <span class="n">msg</span> <span class="o">+</span> <span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="p">)</span></div>



<div class="viewcode-block" id="err">
<a class="viewcode-back" href="../../api/generated/gammapbh.cli.html#gammapbh.cli.err">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">err</span><span class="p">(</span><span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Print an error (red) line.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">Fore</span><span class="o">.</span><span class="n">RED</span> <span class="o">+</span> <span class="s2">&quot;✖ &quot;</span> <span class="o">+</span> <span class="n">msg</span> <span class="o">+</span> <span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="p">)</span></div>



<div class="viewcode-block" id="user_input">
<a class="viewcode-back" href="../../api/generated/gammapbh.cli.html#gammapbh.cli.user_input">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">user_input</span><span class="p">(</span>
    <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">allow_back</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">allow_exit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">allow_comment</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper around :func:`input` that also understands navigation and, optionally,</span>
<span class="sd">    ignores comment-style lines.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    prompt : str</span>
<span class="sd">        Text to display when requesting input from the user.</span>

<span class="sd">    allow_back : bool, optional</span>
<span class="sd">        If True, the special commands ``&quot;b&quot;`` or ``&quot;back&quot;`` (case-insensitive)</span>
<span class="sd">        will *not* be returned as normal input. Instead, a :class:`BackRequested`</span>
<span class="sd">        exception is raised, allowing the caller to return to a previous menu.</span>

<span class="sd">    allow_exit : bool, optional</span>
<span class="sd">        If True, the special commands ``&quot;q&quot;`` or ``&quot;exit&quot;`` (case-insensitive)</span>
<span class="sd">        cause the program to terminate immediately via :func:`sys.exit`. This is</span>
<span class="sd">        used for global “quit” shortcuts in the interactive CLI.</span>

<span class="sd">    allow_comment : bool, optional</span>
<span class="sd">        If True (default), any line whose first non-whitespace character is</span>
<span class="sd">        ``&#39;#&#39;`` is treated as a comment and ignored. This is specifically to make</span>
<span class="sd">        copy–pasted transcripts from the documentation or README work smoothly:</span>
<span class="sd">        users can paste sequences like::</span>

<span class="sd">            gammapbh</span>
<span class="sd">            # Example A — Monochromatic spectra</span>
<span class="sd">            # 1) Select &quot;Monochromatic spectra&quot;</span>
<span class="sd">            1</span>
<span class="sd">            # 2) Enter PBH masses (g)</span>
<span class="sd">            3.14e15, 1.4e14</span>

<span class="sd">        and all ``&#39;# …&#39;`` lines will be skipped until a non-comment line is read.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        The raw user input (with leading/trailing whitespace stripped) that is</span>
<span class="sd">        *not* a navigation/exit command and is not suppressed as a comment.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    BackRequested</span>
<span class="sd">        If the user enters ``&quot;b&quot;`` or ``&quot;back&quot;`` and ``allow_back`` is True.</span>

<span class="sd">    SystemExit</span>
<span class="sd">        If the user enters ``&quot;q&quot;`` or ``&quot;exit&quot;`` and ``allow_exit`` is True.</span>
<span class="sd">        This is the normal way to terminate the top-level CLI loop.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - All comparisons for navigation/exit/comment detection are done on the</span>
<span class="sd">      raw line **before** it is returned to the caller.</span>
<span class="sd">    - The function loops until it encounters a line that is not treated as a</span>
<span class="sd">      comment or navigation/exit command, so callers always receive a</span>
<span class="sd">      meaningful payload string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>

        <span class="c1"># Treat comment-only lines as no-ops so that README examples with &#39;#&#39;</span>
        <span class="c1"># can be copy–pasted directly into an interactive session.</span>
        <span class="k">if</span> <span class="n">allow_comment</span> <span class="ow">and</span> <span class="n">txt</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="n">txt</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">low</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">allow_exit</span> <span class="ow">and</span> <span class="n">low</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;exit&quot;</span><span class="p">,</span> <span class="s2">&quot;q&quot;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exiting software.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">allow_back</span> <span class="ow">and</span> <span class="n">low</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;back&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">BackRequested</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">txt</span></div>




<div class="viewcode-block" id="list_saved_runs">
<a class="viewcode-back" href="../../api/generated/gammapbh.cli.html#gammapbh.cli.list_saved_runs">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">list_saved_runs</span><span class="p">(</span><span class="n">base_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    List child directories beneath `base_dir`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    base_dir : str</span>
<span class="sd">        Root directory containing saved runs.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list[str]</span>
<span class="sd">        Sorted child directory names (no files).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">d</span><span class="p">)))</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span></div>



<div class="viewcode-block" id="snap_to_available">
<a class="viewcode-back" href="../../api/generated/gammapbh.cli.html#gammapbh.cli.snap_to_available">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">snap_to_available</span><span class="p">(</span><span class="n">mval</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">available</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">tol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-12</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If `mval` is essentially equal (in log space) to one of `available` masses,</span>
<span class="sd">    return that available mass. Otherwise return None.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mval : float</span>
<span class="sd">        Desired mass value [g].</span>
<span class="sd">    available : list[float]</span>
<span class="sd">        Pre-rendered masses available.</span>
<span class="sd">    tol : float</span>
<span class="sd">        Allowed absolute difference in ln-space for a snap.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float or None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">available</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">log_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">mval</span><span class="p">)</span>
    <span class="n">log_available</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">available</span><span class="p">))</span>
    <span class="n">diffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">log_available</span> <span class="o">-</span> <span class="n">log_m</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">diffs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">available</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">if</span> <span class="n">diffs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tol</span> <span class="k">else</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="parse_float_list_verbose">
<a class="viewcode-back" href="../../api/generated/gammapbh.cli.html#gammapbh.cli.parse_float_list_verbose">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">parse_float_list_verbose</span><span class="p">(</span>
    <span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;value&quot;</span><span class="p">,</span>
    <span class="n">bounds</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">allow_empty</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">positive_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">strict_gt</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">strict_lt</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse a comma-separated list of floats with verbose validation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s : str</span>
<span class="sd">        Input string, e.g. &quot;1e15, 2e15&quot;.</span>
<span class="sd">    name : str</span>
<span class="sd">        Friendly name used in warning messages.</span>
<span class="sd">    bounds : (float|None, float|None) or None</span>
<span class="sd">        Inclusive (lo, hi) bounds if provided.</span>
<span class="sd">    allow_empty : bool</span>
<span class="sd">        If False and parsing yields nothing, a warning is printed.</span>
<span class="sd">    positive_only : bool</span>
<span class="sd">        If True, keep only values &gt; 0.</span>
<span class="sd">    strict_gt : bool</span>
<span class="sd">        If True and bounds[0] not None: enforce v &gt; lo; else v ≥ lo.</span>
<span class="sd">    strict_lt : bool</span>
<span class="sd">        If True and bounds[1] not None: enforce v &lt; hi; else v ≤ hi.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list[float]</span>
<span class="sd">        Validated, de-duplicated floats (first occurrence kept).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_empty</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">s provided.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">vals</span><span class="p">,</span> <span class="n">seen</span> <span class="o">=</span> <span class="p">[],</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">bounds</span> <span class="ow">or</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">tok</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping token &#39;</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> is not a valid number.&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">positive_only</span> <span class="ow">and</span> <span class="n">v</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">g</span><span class="si">}</span><span class="s2">: must be &gt; 0.&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">lo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">strict_gt</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">v</span> <span class="o">&gt;</span> <span class="n">lo</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">strict_gt</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">v</span> <span class="o">&gt;=</span> <span class="n">lo</span><span class="p">)):</span>
                <span class="n">cmp</span> <span class="o">=</span> <span class="s2">&quot;&gt;&quot;</span> <span class="k">if</span> <span class="n">strict_gt</span> <span class="k">else</span> <span class="s2">&quot;≥&quot;</span>
                <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">g</span><span class="si">}</span><span class="s2">: must be </span><span class="si">{</span><span class="n">cmp</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">lo</span><span class="si">:</span><span class="s2">g</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
        <span class="k">if</span> <span class="n">hi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">strict_lt</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">v</span> <span class="o">&lt;</span> <span class="n">hi</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">strict_lt</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">v</span> <span class="o">&lt;=</span> <span class="n">hi</span><span class="p">)):</span>
                <span class="n">cmp</span> <span class="o">=</span> <span class="s2">&quot;&lt;&quot;</span> <span class="k">if</span> <span class="n">strict_lt</span> <span class="k">else</span> <span class="s2">&quot;≤&quot;</span>
                <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">g</span><span class="si">}</span><span class="s2">: must be </span><span class="si">{</span><span class="n">cmp</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">hi</span><span class="si">:</span><span class="s2">g</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Duplicate </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">g</span><span class="si">}</span><span class="s2">: keeping first, skipping this one.&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">);</span> <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">vals</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">allow_empty</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No usable </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">s parsed.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">vals</span></div>



<span class="c1"># ---------------------------</span>
<span class="c1"># PDFs (collapse space)</span>
<span class="c1"># ---------------------------</span>
<div class="viewcode-block" id="delta_l">
<a class="viewcode-back" href="../../api/generated/gammapbh.cli.html#gammapbh.cli.delta_l">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">delta_l</span><span class="p">(</span><span class="n">mass_ratio</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">kappa</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">delta_c</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">gamma</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert mass ratio to the linear threshold δ_l used in collapse models.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mass_ratio : ndarray</span>
<span class="sd">        Dimensionless M/M_peak (or equivalent model-specific scaling).</span>
<span class="sd">    kappa : float</span>
<span class="sd">    delta_c : float</span>
<span class="sd">    gamma : float</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ndarray</span>
<span class="sd">        δ_l(mass_ratio) with the analytic mapping and a safe clip for the sqrt argument.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">mass_ratio</span> <span class="o">/</span> <span class="n">kappa</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">gamma</span><span class="p">)</span>
    <span class="n">arg</span> <span class="o">=</span> <span class="mi">64</span> <span class="o">-</span> <span class="mi">96</span> <span class="o">*</span> <span class="p">(</span><span class="n">delta_c</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">arg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span> <span class="o">/</span> <span class="mi">6</span></div>



<div class="viewcode-block" id="mass_function">
<a class="viewcode-back" href="../../api/generated/gammapbh.cli.html#gammapbh.cli.mass_function">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">mass_function</span><span class="p">(</span><span class="n">delta_l_val</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">sigma_x</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">delta_c</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">gamma</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gaussian-collapse proxy mass function in δ_l-space.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    delta_l_val : ndarray</span>
<span class="sd">        δ_l grid.</span>
<span class="sd">    sigma_x : float</span>
<span class="sd">        Collapse dispersion parameter.</span>
<span class="sd">    delta_c : float</span>
<span class="sd">        Critical collapse threshold.</span>
<span class="sd">    gamma : float</span>
<span class="sd">        Shape parameter.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ndarray</span>
<span class="sd">        Unnormalized mass function (shape same as input).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">term1</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma_x</span><span class="p">)</span>
    <span class="n">term2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">delta_l_val</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigma_x</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">term3</span> <span class="o">=</span> <span class="n">delta_l_val</span> <span class="o">-</span> <span class="p">(</span><span class="mi">3</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span> <span class="o">*</span> <span class="n">delta_l_val</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">delta_c</span>
    <span class="n">term4</span> <span class="o">=</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">3</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">delta_l_val</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">term1</span> <span class="o">*</span> <span class="n">term2</span> <span class="o">*</span> <span class="n">term3</span> <span class="o">/</span> <span class="n">term4</span></div>



<div class="viewcode-block" id="mass_function_exact">
<a class="viewcode-back" href="../../api/generated/gammapbh.cli.html#gammapbh.cli.mass_function_exact">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">mass_function_exact</span><span class="p">(</span>
    <span class="n">delta_l_val</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">sigma_X</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">sigma_Y</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">delta_c</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">gamma</span><span class="p">:</span> <span class="nb">float</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Non-Gaussian mass function (Biagetti et al., Eq. 20 shape—up to constants),</span>
<span class="sd">    mapped into δ_l with a Jacobian consistent with the collapse mapping used above.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    delta_l_val : ndarray</span>
<span class="sd">        δ_l grid.</span>
<span class="sd">    sigma_X : float</span>
<span class="sd">        Dispersion along X-direction.</span>
<span class="sd">    sigma_Y : float</span>
<span class="sd">        Dispersion along Y-direction (often tied to sigma_X via ratio).</span>
<span class="sd">    delta_c : float</span>
<span class="sd">        Critical threshold.</span>
<span class="sd">    gamma : float</span>
<span class="sd">        Shape parameter for the mapping.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ndarray</span>
<span class="sd">        Unnormalized mass function (shape same as input).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">sigma_X</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">sigma_Y</span> <span class="o">*</span> <span class="n">delta_l_val</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">exp_pref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">sigma_Y</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">term1</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">sigma_Y</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">inner_exp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">sigma_X</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">sigma_Y</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">sigma_X</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">sigma_Y</span> <span class="o">*</span> <span class="n">delta_l_val</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>
    <span class="n">erf_arg</span> <span class="o">=</span> <span class="n">sigma_X</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>  <span class="c1"># stable</span>
    <span class="n">term2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma_X</span> <span class="o">*</span> <span class="n">inner_exp</span> <span class="o">*</span> <span class="n">erf</span><span class="p">(</span><span class="n">erf_arg</span><span class="p">)</span>
    <span class="n">bracket</span> <span class="o">=</span> <span class="n">term1</span> <span class="o">+</span> <span class="n">term2</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">exp_pref</span> <span class="o">*</span> <span class="n">sigma_X</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">A</span><span class="o">**</span><span class="mf">1.5</span><span class="p">)</span>
    <span class="n">jacobian</span> <span class="o">=</span> <span class="p">((</span><span class="n">delta_l_val</span> <span class="o">-</span> <span class="mf">0.375</span> <span class="o">*</span> <span class="n">delta_l_val</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">delta_c</span><span class="p">)</span> <span class="o">/</span>
                <span class="p">(</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="mf">0.75</span> <span class="o">*</span> <span class="n">delta_l_val</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">norm</span> <span class="o">*</span> <span class="n">bracket</span> <span class="o">*</span> <span class="n">jacobian</span></div>



<div class="viewcode-block" id="mass_function_lognormal">
<a class="viewcode-back" href="../../api/generated/gammapbh.cli.html#gammapbh.cli.mass_function_lognormal">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">mass_function_lognormal</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">mu</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Standard log-normal PDF in variable x.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : ndarray</span>
<span class="sd">        Positive support (will be clipped below to avoid divide-by-zero).</span>
<span class="sd">    mu : float</span>
<span class="sd">        Mean in ln-space.</span>
<span class="sd">    sigma : float</span>
<span class="sd">        Std. dev. in ln-space (must be &gt; 0).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ndarray</span>
<span class="sd">        Log-normal PDF values at x.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x_clipped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">1e-16</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">x_clipped</span> <span class="o">*</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
            <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x_clipped</span><span class="p">)</span> <span class="o">-</span> <span class="n">mu</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span></div>



<span class="c1"># ---------------------------</span>
<span class="c1"># Data loaders</span>
<span class="c1"># ---------------------------</span>
<div class="viewcode-block" id="load_data">
<a class="viewcode-back" href="../../api/generated/gammapbh.cli.html#gammapbh.cli.load_data">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">load_data</span><span class="p">(</span><span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">skip_header</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A thin wrapper around `numpy.genfromtxt` with explicit header skipping.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filepath : str</span>
<span class="sd">        Path to file.</span>
<span class="sd">    skip_header : int</span>
<span class="sd">        Number of header lines to skip.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ndarray</span>
<span class="sd">        Parsed numeric array.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    FileNotFoundError</span>
<span class="sd">        If file does not exist.</span>
<span class="sd">    ValueError</span>
<span class="sd">        If `genfromtxt` fails due to column inconsistency.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File not found: </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">skip_header</span><span class="o">=</span><span class="n">skip_header</span><span class="p">)</span></div>



<div class="viewcode-block" id="load_xy_lenient">
<a class="viewcode-back" href="../../api/generated/gammapbh.cli.html#gammapbh.cli.load_xy_lenient">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">load_xy_lenient</span><span class="p">(</span><span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">skip_header</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">min_cols</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Robustly load at least two numeric columns from a whitespace/CSV-like text file,</span>
<span class="sd">    skipping blank lines, comment lines, and any lines with fewer than `min_cols` tokens.</span>

<span class="sd">    This specifically fixes files where the first data row contains a single integer</span>
<span class="sd">    (e.g., a length or counter), followed by proper 2-column numeric rows; vanilla</span>
<span class="sd">    `genfromtxt` would lock onto the one-column width and then error.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filepath : str</span>
<span class="sd">        Path to the file to read.</span>
<span class="sd">    skip_header : int, optional</span>
<span class="sd">        Number of initial lines to skip unconditionally.</span>
<span class="sd">    min_cols : int, optional</span>
<span class="sd">        Minimum number of numeric columns required to accept a line (default 2).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ndarray</span>
<span class="sd">        Array of shape (N, &gt;=min_cols). Only the first `min_cols` columns are guaranteed.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    FileNotFoundError</span>
<span class="sd">        If the file does not exist.</span>
<span class="sd">    ValueError</span>
<span class="sd">        If no usable numeric rows are found.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Treats lines starting with &#39;#&#39; as comments.</span>
<span class="sd">    - Replaces commas with spaces to tolerate CSV-ish files.</span>
<span class="sd">    - Silently skips lines that fail float conversion or are too short.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File not found: </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">raw</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fh</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">skip_header</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_cols</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">nums</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">min_cols</span><span class="p">)]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No usable numeric rows with ≥</span><span class="si">{</span><span class="n">min_cols</span><span class="si">}</span><span class="s2"> columns in </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span></div>



<div class="viewcode-block" id="load_spectra_components">
<a class="viewcode-back" href="../../api/generated/gammapbh.cli.html#gammapbh.cli.load_spectra_components">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">load_spectra_components</span><span class="p">(</span><span class="n">directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load and align spectral components for a given mass-directory.</span>

<span class="sd">    Files expected in `directory`</span>
<span class="sd">    -----------------------------</span>
<span class="sd">    instantaneous_primary_spectra.txt</span>
<span class="sd">        Columns: E(GeV)  dN/dE (GeV^-1 s^-1)  [we later convert E to MeV and flux to MeV^-1 s^-1]</span>
<span class="sd">    instantaneous_secondary_spectra.txt</span>
<span class="sd">        Columns: E(MeV)  dN/dE (MeV^-1 s^-1)</span>
<span class="sd">    inflight_annihilation_prim.txt</span>
<span class="sd">        Typically two columns (E(MeV), rate) but may contain a spurious single-number line first.</span>
<span class="sd">    inflight_annihilation_sec.txt</span>
<span class="sd">        Same caveat as above.</span>
<span class="sd">    final_state_radiation_prim.txt</span>
<span class="sd">        Typically two columns, sometimes with one header line to skip.</span>
<span class="sd">    final_state_radiation_sec.txt</span>
<span class="sd">        Typically two columns, sometimes with one header line to skip.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict[str, ndarray]</span>
<span class="sd">        Keys:</span>
<span class="sd">            energy_primary, energy_secondary,</span>
<span class="sd">            direct_gamma_primary, direct_gamma_secondary,</span>
<span class="sd">            IFA_primary, IFA_secondary,</span>
<span class="sd">            FSR_primary, FSR_secondary</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - This function now uses `load_xy_lenient` for IFA/FSR files to survive files with</span>
<span class="sd">      leading single-value rows.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">primary</span>   <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;instantaneous_primary_spectra.txt&quot;</span><span class="p">),</span>   <span class="n">skip_header</span><span class="o">=</span><span class="mi">2</span><span class="p">)[</span><span class="mi">123</span><span class="p">:]</span>
    <span class="n">secondary</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;instantaneous_secondary_spectra.txt&quot;</span><span class="p">),</span> <span class="n">skip_header</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># lenient loads for files that sometimes start with a single-number row</span>
    <span class="n">IFA_prim</span>  <span class="o">=</span> <span class="n">load_xy_lenient</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;inflight_annihilation_prim.txt&quot;</span><span class="p">))</span>
    <span class="n">IFA_sec</span>   <span class="o">=</span> <span class="n">load_xy_lenient</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;inflight_annihilation_sec.txt&quot;</span><span class="p">))</span>
    <span class="n">FSR_prim</span>  <span class="o">=</span> <span class="n">load_xy_lenient</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;final_state_radiation_prim.txt&quot;</span><span class="p">),</span> <span class="n">skip_header</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">FSR_sec</span>   <span class="o">=</span> <span class="n">load_xy_lenient</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;final_state_radiation_sec.txt&quot;</span><span class="p">),</span>  <span class="n">skip_header</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">E_prim</span> <span class="o">=</span> <span class="n">primary</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e3</span>  <span class="c1"># convert GeV → MeV</span>
    <span class="n">E_sec</span>  <span class="o">=</span> <span class="n">secondary</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>      <span class="c1"># already in MeV</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;energy_primary&#39;</span><span class="p">:</span>         <span class="n">E_prim</span><span class="p">,</span>
        <span class="s1">&#39;energy_secondary&#39;</span><span class="p">:</span>       <span class="n">E_sec</span><span class="p">,</span>
        <span class="s1">&#39;direct_gamma_primary&#39;</span><span class="p">:</span>   <span class="n">primary</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1e3</span><span class="p">,</span>  <span class="c1"># GeV^-1 → MeV^-1</span>
        <span class="s1">&#39;direct_gamma_secondary&#39;</span><span class="p">:</span> <span class="n">secondary</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="s1">&#39;IFA_primary&#39;</span><span class="p">:</span>            <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">E_prim</span><span class="p">,</span> <span class="n">IFA_prim</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">IFA_prim</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">left</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.0</span><span class="p">),</span>
        <span class="s1">&#39;IFA_secondary&#39;</span><span class="p">:</span>          <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">E_sec</span><span class="p">,</span>  <span class="n">IFA_sec</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>  <span class="n">IFA_sec</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>  <span class="n">left</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.0</span><span class="p">),</span>
        <span class="s1">&#39;FSR_primary&#39;</span><span class="p">:</span>            <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">E_prim</span><span class="p">,</span> <span class="n">FSR_prim</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">FSR_prim</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]),</span>
        <span class="s1">&#39;FSR_secondary&#39;</span><span class="p">:</span>          <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">E_sec</span><span class="p">,</span>  <span class="n">FSR_sec</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>  <span class="n">FSR_sec</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]),</span>
    <span class="p">}</span></div>



<span class="c1"># ---------------------------</span>
<span class="c1"># Monochromatic</span>
<span class="c1"># ---------------------------</span>
<div class="viewcode-block" id="generate_monochromatic_for_mass">
<a class="viewcode-back" href="../../api/generated/gammapbh.cli.html#gammapbh.cli.generate_monochromatic_for_mass">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_monochromatic_for_mass</span><span class="p">(</span><span class="n">target_mass</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate (or more precisely, assemble) a monochromatic spectrum file for the</span>
<span class="sd">    nearest available pre-rendered mass to `target_mass`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    target_mass : float</span>
<span class="sd">        Desired PBH mass [g].</span>
<span class="sd">    data_dir : str</span>
<span class="sd">        Directory containing the BlackHawk mass folders.</span>
<span class="sd">    out_dir : str</span>
<span class="sd">        Directory to write the output TXT file.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Path to the saved monochromatic spectrum file. Columns:</span>
<span class="sd">            E_gamma(MeV), TotalSpectrum(MeV^-1 s^-1)</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - We re-compute the *total* as Direct + Secondary + IFA + FSR aligned onto the</span>
<span class="sd">      primary energy grid for consistency with plotting routines.</span>
<span class="sd">    - The output file name encodes the requested mass, not the snapped mass, to</span>
<span class="sd">      reflect the user&#39;s intention; the data inside reflects the snapped folder.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">masses</span><span class="p">,</span> <span class="n">names</span> <span class="o">=</span> <span class="n">discover_mass_folders</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">masses</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No valid mass folders found to generate monochromatic spectrum.&quot;</span><span class="p">)</span>
    <span class="n">snap</span> <span class="o">=</span> <span class="n">snap_to_available</span><span class="p">(</span><span class="n">target_mass</span><span class="p">,</span> <span class="n">masses</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">snap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># choose nearest in log-space</span>
        <span class="n">log_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">target_mass</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">masses</span><span class="p">)</span> <span class="o">-</span> <span class="n">log_t</span><span class="p">)))</span>
        <span class="n">snap</span> <span class="o">=</span> <span class="n">masses</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">idx_snap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">masses</span><span class="p">,</span> <span class="n">snap</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sub</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">names</span><span class="p">[</span><span class="n">idx_snap</span><span class="p">])</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">load_spectra_components</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>

    <span class="c1"># align everything on the primary grid</span>
    <span class="n">E</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="s1">&#39;energy_primary&#39;</span><span class="p">]</span>
    <span class="n">total</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">S</span><span class="p">[</span><span class="s1">&#39;direct_gamma_primary&#39;</span><span class="p">]</span>
        <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">S</span><span class="p">[</span><span class="s1">&#39;energy_secondary&#39;</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="s1">&#39;direct_gamma_secondary&#39;</span><span class="p">],</span> <span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">S</span><span class="p">[</span><span class="s1">&#39;IFA_primary&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">S</span><span class="p">[</span><span class="s1">&#39;energy_secondary&#39;</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="s1">&#39;IFA_secondary&#39;</span><span class="p">],</span> <span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">S</span><span class="p">[</span><span class="s1">&#39;FSR_primary&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">S</span><span class="p">[</span><span class="s1">&#39;energy_secondary&#39;</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="s1">&#39;FSR_secondary&#39;</span><span class="p">],</span> <span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">out_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target_mass</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">_mono_generated.txt&quot;</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">out_name</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">E</span><span class="p">,</span> <span class="n">total</span><span class="p">)),</span>
               <span class="n">header</span><span class="o">=</span><span class="s2">&quot;E_gamma(MeV)   TotalSpectrum (MeV^-1 s^-1)&quot;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%.10e</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out_name</span></div>



<div class="viewcode-block" id="monochromatic_spectra">
<a class="viewcode-back" href="../../api/generated/gammapbh.cli.html#gammapbh.cli.monochromatic_spectra">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">monochromatic_spectra</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Interactive tool to plot one or more monochromatic spectra.</span>

<span class="sd">    Flow</span>
<span class="sd">    ----</span>
<span class="sd">    1) Discover available pre-rendered masses.</span>
<span class="sd">    2) Ask user to enter a comma-separated list of target masses.</span>
<span class="sd">    3) Build logM–logE splines across the full mass grid to allow interpolation</span>
<span class="sd">       for off-grid masses as needed.</span>
<span class="sd">    4) For each requested mass, plot component curves and total; then offer to</span>
<span class="sd">       save selected spectra into the monochromatic results folder.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">masses</span><span class="p">,</span> <span class="n">names</span> <span class="o">=</span> <span class="n">discover_mass_folders</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">masses</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No valid mass folders found under: </span><span class="si">{</span><span class="n">DATA_DIR</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">MIN_MASS</span><span class="p">,</span> <span class="n">MAX_MASS</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">masses</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">masses</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">masses_str</span> <span class="o">=</span> <span class="n">user_input</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Enter PBH masses (g) to simulate (comma-separated; allowed range [</span><span class="si">{</span><span class="n">MIN_MASS</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">MAX_MASS</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">]): &quot;</span><span class="p">,</span>
            <span class="n">allow_back</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="n">BackRequested</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">mass_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">masses_str</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">masses_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">tok</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mval</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping mass token &#39;</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">&#39;: not a number.&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">MIN_MASS</span> <span class="o">&lt;=</span> <span class="n">mval</span> <span class="o">&lt;=</span> <span class="n">MAX_MASS</span><span class="p">):</span>
                <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping mass </span><span class="si">{</span><span class="n">mval</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2"> g: outside allowed range [</span><span class="si">{</span><span class="n">MIN_MASS</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">MAX_MASS</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">].&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">mass_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mval</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">mass_list</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;No valid masses provided. Returning to menu.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">info</span><span class="p">(</span><span class="s2">&quot;Pre-loading pre-rendered components …&quot;</span><span class="p">)</span>
    <span class="n">first_S</span> <span class="o">=</span> <span class="n">load_spectra_components</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">,</span> <span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">E_ref</span>   <span class="o">=</span> <span class="n">first_S</span><span class="p">[</span><span class="s1">&#39;energy_primary&#39;</span><span class="p">]</span>
    <span class="n">N_E</span>     <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">E_ref</span><span class="p">)</span>
    <span class="n">N_M</span>     <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">masses</span><span class="p">)</span>

    <span class="n">direct_mat</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N_M</span><span class="p">,</span> <span class="n">N_E</span><span class="p">))</span>
    <span class="n">secondary_mat</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N_M</span><span class="p">,</span> <span class="n">N_E</span><span class="p">))</span>
    <span class="n">inflight_mat</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N_M</span><span class="p">,</span> <span class="n">N_E</span><span class="p">))</span>
    <span class="n">finalstate_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N_M</span><span class="p">,</span> <span class="n">N_E</span><span class="p">))</span>
    <span class="n">Emax_ifa</span>       <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N_M</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">masses</span><span class="p">):</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">,</span> <span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">S</span> <span class="o">=</span> <span class="n">load_spectra_components</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>
        <span class="n">direct_mat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>     <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="s1">&#39;direct_gamma_primary&#39;</span><span class="p">]</span>
        <span class="n">secondary_mat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">E_ref</span><span class="p">,</span> <span class="n">S</span><span class="p">[</span><span class="s1">&#39;energy_secondary&#39;</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="s1">&#39;direct_gamma_secondary&#39;</span><span class="p">],</span> <span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">inflight_mat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>   <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="s1">&#39;IFA_primary&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">E_ref</span><span class="p">,</span> <span class="n">S</span><span class="p">[</span><span class="s1">&#39;energy_secondary&#39;</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="s1">&#39;IFA_secondary&#39;</span><span class="p">],</span> <span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">finalstate_mat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="s1">&#39;FSR_primary&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">E_ref</span><span class="p">,</span> <span class="n">S</span><span class="p">[</span><span class="s1">&#39;energy_secondary&#39;</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="s1">&#39;FSR_secondary&#39;</span><span class="p">],</span> <span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">load_xy_lenient</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="s2">&quot;inflight_annihilation_prim.txt&quot;</span><span class="p">))</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">load_xy_lenient</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="s2">&quot;inflight_annihilation_sec.txt&quot;</span><span class="p">))</span>
        <span class="n">Emax_ifa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">p</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">size</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">size</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">logM_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">masses</span><span class="p">)</span>
    <span class="n">logE</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">E_ref</span><span class="p">)</span>
    <span class="n">tiny</span>     <span class="o">=</span> <span class="mf">1e-300</span>

    <span class="n">ld</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">direct_mat</span><span class="o">&gt;</span><span class="n">tiny</span><span class="p">,</span>     <span class="n">direct_mat</span><span class="p">,</span>     <span class="n">tiny</span><span class="p">))</span>
    <span class="n">ls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">secondary_mat</span><span class="o">&gt;</span><span class="n">tiny</span><span class="p">,</span>  <span class="n">secondary_mat</span><span class="p">,</span>  <span class="n">tiny</span><span class="p">))</span>
    <span class="n">li</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">inflight_mat</span><span class="o">&gt;</span><span class="n">tiny</span><span class="p">,</span>   <span class="n">inflight_mat</span><span class="p">,</span>   <span class="n">tiny</span><span class="p">))</span>
    <span class="n">lf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">finalstate_mat</span><span class="o">&gt;</span><span class="n">tiny</span><span class="p">,</span> <span class="n">finalstate_mat</span><span class="p">,</span> <span class="n">tiny</span><span class="p">))</span>

    <span class="n">spline_direct</span>     <span class="o">=</span> <span class="n">RectBivariateSpline</span><span class="p">(</span><span class="n">logM_all</span><span class="p">,</span> <span class="n">logE</span><span class="p">,</span> <span class="n">ld</span><span class="p">,</span> <span class="n">kx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ky</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">spline_secondary</span>  <span class="o">=</span> <span class="n">RectBivariateSpline</span><span class="p">(</span><span class="n">logM_all</span><span class="p">,</span> <span class="n">logE</span><span class="p">,</span> <span class="n">ls</span><span class="p">,</span> <span class="n">kx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ky</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">spline_inflight</span>   <span class="o">=</span> <span class="n">RectBivariateSpline</span><span class="p">(</span><span class="n">logM_all</span><span class="p">,</span> <span class="n">logE</span><span class="p">,</span> <span class="n">li</span><span class="p">,</span> <span class="n">kx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ky</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">spline_finalstate</span> <span class="o">=</span> <span class="n">RectBivariateSpline</span><span class="p">(</span><span class="n">logM_all</span><span class="p">,</span> <span class="n">logE</span><span class="p">,</span> <span class="n">lf</span><span class="p">,</span> <span class="n">kx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ky</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">info</span><span class="p">(</span><span class="s2">&quot;Built splines (linear in logM, cubic in logE).&quot;</span><span class="p">)</span>

    <span class="n">all_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">mval</span> <span class="ow">in</span> <span class="n">mass_list</span><span class="p">:</span>
        <span class="n">snapped</span> <span class="o">=</span> <span class="n">snap_to_available</span><span class="p">(</span><span class="n">mval</span><span class="p">,</span> <span class="n">masses</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">snapped</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">masses</span><span class="p">,</span> <span class="n">snapped</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;pre-rendered&#39;</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">direct_mat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">secondary_mat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">it</span><span class="o">=</span> <span class="n">inflight_mat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">finalstate_mat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;interpolated&#39;</span>
            <span class="n">idx_up</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">masses</span><span class="p">,</span> <span class="n">mval</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">))</span>
            <span class="n">idx_low</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">idx_up</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">idx_up</span>  <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">idx_up</span><span class="p">,</span> <span class="n">N_M</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">Ecut</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">Emax_ifa</span><span class="p">[</span><span class="n">idx_low</span><span class="p">],</span> <span class="n">Emax_ifa</span><span class="p">[</span><span class="n">idx_up</span><span class="p">])</span>
            <span class="n">logm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">mval</span><span class="p">)</span>
            <span class="n">d</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">spline_direct</span><span class="p">(</span><span class="n">logm</span><span class="p">,</span> <span class="n">logE</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
            <span class="n">s</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">spline_secondary</span><span class="p">(</span><span class="n">logm</span><span class="p">,</span> <span class="n">logE</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
            <span class="n">it</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">spline_inflight</span><span class="p">(</span><span class="n">logm</span><span class="p">,</span> <span class="n">logE</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
            <span class="n">f</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">spline_finalstate</span><span class="p">(</span><span class="n">logm</span><span class="p">,</span> <span class="n">logE</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
            <span class="c1"># Guard tails in inflight</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">it</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">it</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">it</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">):</span>
                    <span class="n">it</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="n">log10i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">it</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">tiny</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">log10i</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">log10i</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">log10i</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">50</span><span class="p">:</span>
                    <span class="n">it</span><span class="p">[</span><span class="n">j</span><span class="p">:]</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="k">break</span>
            <span class="n">it</span><span class="p">[</span><span class="n">E_ref</span> <span class="o">&gt;=</span> <span class="n">Ecut</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">tot</span> <span class="o">=</span> <span class="n">d</span> <span class="o">+</span> <span class="n">s</span> <span class="o">+</span> <span class="n">it</span> <span class="o">+</span> <span class="n">f</span>
        <span class="n">tol</span> <span class="o">=</span> <span class="mf">1e-299</span>
        <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">tot</span><span class="p">):</span>
            <span class="n">arr</span><span class="p">[</span><span class="n">arr</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># Plot components and total</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">d</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>  <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">E_ref</span><span class="p">[</span><span class="n">d</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">],</span>  <span class="n">d</span><span class="p">[</span><span class="n">d</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">],</span>  <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Direct Hawking&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">s</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>  <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">E_ref</span><span class="p">[</span><span class="n">s</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">],</span>  <span class="n">s</span><span class="p">[</span><span class="n">s</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">],</span>  <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Secondary&quot;</span><span class="p">,</span>     <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">it</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">E_ref</span><span class="p">[</span><span class="n">it</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">],</span> <span class="n">it</span><span class="p">[</span><span class="n">it</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Inflight&quot;</span><span class="p">,</span>      <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">f</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>  <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">E_ref</span><span class="p">[</span><span class="n">f</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">],</span>  <span class="n">f</span><span class="p">[</span><span class="n">f</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">],</span>  <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Final State&quot;</span><span class="p">,</span>   <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">tot</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">E_ref</span><span class="p">[</span><span class="n">tot</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">],</span><span class="n">tot</span><span class="p">[</span><span class="n">tot</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;k.&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Total Spectrum&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$E_\gamma$ (MeV)&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$dN_\gamma/dE_\gamma$ (MeV$^{-1}$ s$^{-1}$)&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">peak_total</span> <span class="o">=</span> <span class="n">tot</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">if</span> <span class="n">tot</span><span class="o">.</span><span class="n">size</span> <span class="k">else</span> <span class="mf">1e-20</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">peak_total</span><span class="o">/</span><span class="mf">1e3</span><span class="p">,</span> <span class="n">peak_total</span><span class="o">*</span><span class="mf">1e1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">5000.0</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Components for </span><span class="si">{</span><span class="n">mval</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1"> g (</span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">all_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;mass&#39;</span><span class="p">:</span> <span class="n">mval</span><span class="p">,</span> <span class="s1">&#39;kind&#39;</span><span class="p">:</span> <span class="n">kind</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">:</span> <span class="n">E_ref</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
            <span class="s1">&#39;direct&#39;</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="s1">&#39;secondary&#39;</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
            <span class="s1">&#39;inflight&#39;</span><span class="p">:</span> <span class="n">it</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="s1">&#39;finalstate&#39;</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
            <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="n">tot</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="p">})</span>

    <span class="c1"># Overlaid E² dN/dE plot across all requested masses</span>
    <span class="k">if</span> <span class="n">all_data</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
        <span class="n">summed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">all_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;E&#39;</span><span class="p">])</span>
        <span class="n">peaks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">all_data</span><span class="p">:</span>
            <span class="n">Ecur</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;E&#39;</span><span class="p">];</span> <span class="n">tot</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">];</span> <span class="n">valid</span> <span class="o">=</span> <span class="n">tot</span><span class="o">&gt;</span><span class="mi">0</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">valid</span><span class="p">):</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Ecur</span><span class="p">[</span><span class="n">valid</span><span class="p">],</span> <span class="n">Ecur</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">tot</span><span class="p">[</span><span class="n">valid</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                         <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;mass&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> g (</span><span class="si">{</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;kind&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="n">summed</span> <span class="o">+=</span> <span class="n">tot</span>
                <span class="n">peaks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">Ecur</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">tot</span><span class="p">[</span><span class="n">valid</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">vs</span> <span class="o">=</span> <span class="n">summed</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">all_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;E&#39;</span><span class="p">][</span><span class="n">vs</span><span class="p">],</span> <span class="n">all_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;E&#39;</span><span class="p">][</span><span class="n">vs</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">summed</span><span class="p">[</span><span class="n">vs</span><span class="p">],</span>
                 <span class="s1">&#39;k:&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Summed&quot;</span><span class="p">)</span>
        <span class="n">ymax_o</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">peaks</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e1</span>
        <span class="n">ymin_o</span> <span class="o">=</span> <span class="n">ymax_o</span> <span class="o">/</span> <span class="mf">1e3</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$E_\gamma$ (MeV)&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$E^2 dN_\gamma/dE_\gamma$ (MeV s$^{-1}$)&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">5000.0</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">ymin_o</span><span class="p">,</span> <span class="n">ymax_o</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Total Hawking Radiation Spectra (E²·dN/dE)&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

        <span class="n">sv</span> <span class="o">=</span> <span class="n">user_input</span><span class="p">(</span><span class="s2">&quot;Save any spectra? (y/n): &quot;</span><span class="p">,</span> <span class="n">allow_back</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">allow_exit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">sv</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;yes&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Select spectra by index to save (single file each):&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_data</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;mass&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> g (</span><span class="si">{</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;kind&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="n">choice</span> <span class="o">=</span> <span class="n">user_input</span><span class="p">(</span><span class="s2">&quot;Enter comma-separated indices (e.g. 1,3,5) or &#39;0&#39; to save ALL: &quot;</span><span class="p">,</span>
                                <span class="n">allow_back</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">allow_exit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">choice</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span><span class="p">:</span>
                <span class="n">picks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_data</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">picks</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">choice</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">err</span><span class="p">(</span><span class="s2">&quot;Invalid indices; skipping save.&quot;</span><span class="p">)</span>
                    <span class="n">picks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">picks</span><span class="p">:</span>
                <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_data</span><span class="p">):</span>
                    <span class="n">e</span> <span class="o">=</span> <span class="n">all_data</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="n">mass_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;mass&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MONO_RESULTS_DIR</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mass_label</span><span class="si">}</span><span class="s2">_spectrum.txt&quot;</span><span class="p">)</span>
                    <span class="n">data_cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span>
                        <span class="n">e</span><span class="p">[</span><span class="s1">&#39;E&#39;</span><span class="p">],</span>
                        <span class="n">e</span><span class="p">[</span><span class="s1">&#39;direct&#39;</span><span class="p">],</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;secondary&#39;</span><span class="p">],</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;inflight&#39;</span><span class="p">],</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;finalstate&#39;</span><span class="p">],</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span>
                    <span class="p">))</span>
                    <span class="n">header</span> <span class="o">=</span> <span class="s2">&quot;E_gamma(MeV)    Direct    Secondary    Inflight    FinalState    Total (MeV^-1 s^-1)&quot;</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">data_cols</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%e</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved → </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<span class="c1"># ---------------------------</span>
<span class="c1"># Right-edge spike trimming helper (kept for reference)</span>
<span class="c1"># ---------------------------</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_trim_right_spike</span><span class="p">(</span>
    <span class="n">x_line</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">y_line</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">up_thresh</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.35</span><span class="p">,</span>
    <span class="n">down_thresh</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.35</span><span class="p">,</span>
    <span class="n">max_trim_frac</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.10</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Heuristic to trim a suspicious final spike/drop on the right edge of a curve.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x_line : ndarray</span>
<span class="sd">        X grid (unused in logic; provided for potential future use).</span>
<span class="sd">    y_line : ndarray</span>
<span class="sd">        Y values to inspect.</span>
<span class="sd">    up_thresh : float</span>
<span class="sd">        If y[-1]/y[-2] &gt; up_thresh, treat as spike.</span>
<span class="sd">    down_thresh : float</span>
<span class="sd">        If y[-1]/y[-2] &lt; down_thresh, treat as plunge.</span>
<span class="sd">    max_trim_frac : float</span>
<span class="sd">        Do not trim more than this fraction of the array length.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        New usable length index (exclusive). Caller may slice up to this index.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_line</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">size</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">y_nm1</span><span class="p">,</span> <span class="n">y_nm2</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_nm1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_nm2</span><span class="p">))</span> <span class="ow">or</span> <span class="n">y_nm2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">ratio</span> <span class="o">=</span> <span class="n">y_nm1</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">y_nm2</span><span class="p">,</span> <span class="mf">1e-300</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ratio</span> <span class="o">&lt;=</span> <span class="n">up_thresh</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ratio</span> <span class="o">&gt;=</span> <span class="n">down_thresh</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">max_trim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_trim_frac</span> <span class="o">*</span> <span class="n">n</span><span class="p">))</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">trimmed</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">ratio</span> <span class="o">&gt;</span> <span class="n">up_thresh</span><span class="p">:</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">trimmed</span> <span class="o">&lt;</span> <span class="n">max_trim</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="ow">and</span>
               <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mf">1e-300</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">up_thresh</span><span class="p">)):</span>
            <span class="n">j</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">trimmed</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">trimmed</span> <span class="o">&lt;</span> <span class="n">max_trim</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="ow">and</span>
           <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mf">1e-300</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">down_thresh</span><span class="p">)):</span>
        <span class="n">j</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">trimmed</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>


<span class="c1"># ---------------------------</span>
<span class="c1"># Distributed (Gaussian collapse / Non-Gaussian / Lognormal)</span>
<span class="c1"># ---------------------------</span>
<div class="viewcode-block" id="distributed_spectrum">
<a class="viewcode-back" href="../../api/generated/gammapbh.cli.html#gammapbh.cli.distributed_spectrum">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">distributed_spectrum</span><span class="p">(</span><span class="n">distribution_method</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate distributed spectra using one of the supported PBH mass distributions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    distribution_method : str</span>
<span class="sd">        One of:</span>
<span class="sd">            - GAUSSIAN_METHOD (&quot;Gaussian collapse&quot;)</span>
<span class="sd">            - NON_GAUSSIAN_METHOD (&quot;Non-Gaussian Collapse&quot;)</span>
<span class="sd">            - LOGNORMAL_METHOD (&quot;Log-Normal Distribution&quot;)</span>

<span class="sd">    Interactive Flow</span>
<span class="sd">    ----------------</span>
<span class="sd">    1) Prompt for one or more peak masses (must lie within available pre-rendered grid).</span>
<span class="sd">    2) Prompt for target sample size N.</span>
<span class="sd">    3) Prompt for distribution-specific width parameter(s) (σ / σ_X / σ in ln-space).</span>
<span class="sd">    4) Sample masses, accumulate average spectra via log–log splines (with IFA tail guards).</span>
<span class="sd">    5) Plot dN/dE and E² dN/dE overlays across all chosen parameter sets.</span>
<span class="sd">    6) For each set, plot its mass histogram with a counts-scaled analytic PDF overlay.</span>
<span class="sd">    7) Offer to save results into a unique directory under the method-specific results root.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - For Non-Gaussian, we enforce 0.04 ≤ σ_X ≤ 0.16 and set σ_Y/σ_X = 0.75 (typical choice).</span>
<span class="sd">    - For Log-Normal, we interpret the user&#39;s σ as the ln-space standard deviation and choose</span>
<span class="sd">      μ such that the mode equals the requested peak (μ_eff = ln(peak) + σ²).</span>
<span class="sd">    - All interpolation occurs in (logM, logE) space; inflight annihilation tails are trimmed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">is_g</span>  <span class="o">=</span> <span class="p">(</span><span class="n">distribution_method</span> <span class="o">==</span> <span class="n">GAUSSIAN_METHOD</span><span class="p">)</span>
    <span class="n">is_ng</span> <span class="o">=</span> <span class="p">(</span><span class="n">distribution_method</span> <span class="o">==</span> <span class="n">NON_GAUSSIAN_METHOD</span><span class="p">)</span>
    <span class="n">is_ln</span> <span class="o">=</span> <span class="p">(</span><span class="n">distribution_method</span> <span class="o">==</span> <span class="n">LOGNORMAL_METHOD</span><span class="p">)</span>

    <span class="n">masses</span><span class="p">,</span> <span class="n">names</span> <span class="o">=</span> <span class="n">discover_mass_folders</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">masses</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No valid mass folders found under: </span><span class="si">{</span><span class="n">DATA_DIR</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">MIN_MASS</span><span class="p">,</span> <span class="n">MAX_MASS</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">masses</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">masses</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">pstr</span> <span class="o">=</span> <span class="n">user_input</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Enter peak PBH masses (g) (comma-separated; each must be within [</span><span class="si">{</span><span class="n">MIN_MASS</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">MAX_MASS</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">]): &quot;</span><span class="p">,</span>
            <span class="n">allow_back</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">allow_exit</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="n">BackRequested</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">peaks</span> <span class="o">=</span> <span class="n">parse_float_list_verbose</span><span class="p">(</span><span class="n">pstr</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;peak mass (g)&quot;</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="n">MIN_MASS</span><span class="p">,</span> <span class="n">MAX_MASS</span><span class="p">),</span> <span class="n">allow_empty</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">peaks</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;No valid peaks; returning.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">nstr</span> <span class="o">=</span> <span class="n">user_input</span><span class="p">(</span><span class="s2">&quot;Enter target N (integer, e.g. 1000): &quot;</span><span class="p">,</span>
                          <span class="n">allow_back</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">allow_exit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">BackRequested</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">N_target</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nstr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">N_target</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">err</span><span class="p">(</span><span class="s2">&quot;N must be &gt; 0. Returning.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">err</span><span class="p">(</span><span class="s2">&quot;Invalid N (not an integer). Returning.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># collapse parameters (shared constants used in the literature fitting)</span>
    <span class="n">kappa</span><span class="p">,</span> <span class="n">gamma_p</span><span class="p">,</span> <span class="n">delta_c</span> <span class="o">=</span> <span class="mf">3.3</span><span class="p">,</span> <span class="mf">0.36</span><span class="p">,</span> <span class="mf">0.59</span>

    <span class="c1"># read parameter lists</span>
    <span class="n">param_sets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">is_g</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sstr</span> <span class="o">=</span> <span class="n">user_input</span><span class="p">(</span><span class="s2">&quot;Enter σ list for Gaussian collapse (comma-separated; each must be within [0.03, 0.255]): &quot;</span><span class="p">,</span>
                              <span class="n">allow_back</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">allow_exit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">BackRequested</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">sigmas</span> <span class="o">=</span> <span class="n">parse_float_list_verbose</span><span class="p">(</span><span class="n">sstr</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;σ&quot;</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.255</span><span class="p">),</span> <span class="n">allow_empty</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sigmas</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;No valid σ for Gaussian; returning.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">sx</span> <span class="ow">in</span> <span class="n">sigmas</span><span class="p">:</span>
            <span class="n">param_sets</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;sigma_x&quot;</span><span class="p">:</span> <span class="n">sx</span><span class="p">})</span>

    <span class="k">elif</span> <span class="n">is_ng</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sx_str</span> <span class="o">=</span> <span class="n">user_input</span><span class="p">(</span><span class="s2">&quot;Enter σ_X list for Non-Gaussian collapse (comma-separated; σ must be within [0.04, 0.16]): &quot;</span><span class="p">,</span>
                                <span class="n">allow_back</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">allow_exit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">BackRequested</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">sigmas_X</span> <span class="o">=</span> <span class="n">parse_float_list_verbose</span><span class="p">(</span><span class="n">sx_str</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;σ_X&quot;</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">0.04</span><span class="p">,</span> <span class="mf">0.16</span><span class="p">),</span> <span class="n">allow_empty</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sigmas_X</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;No valid σ for Non-Gaussian; returning.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">sX</span> <span class="ow">in</span> <span class="n">sigmas_X</span><span class="p">:</span>
            <span class="n">param_sets</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;sigma_X&quot;</span><span class="p">:</span> <span class="n">sX</span><span class="p">,</span> <span class="s2">&quot;ratio&quot;</span><span class="p">:</span> <span class="mf">0.75</span><span class="p">})</span>

    <span class="k">else</span><span class="p">:</span>  <span class="c1"># is_ln</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sig_str</span> <span class="o">=</span> <span class="n">user_input</span><span class="p">(</span><span class="s2">&quot;Enter σ list (log-space std) for Log-Normal (comma-separated; each &gt; 0): &quot;</span><span class="p">,</span>
                                 <span class="n">allow_back</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">allow_exit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">BackRequested</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">sigmas_ln</span> <span class="o">=</span> <span class="n">parse_float_list_verbose</span><span class="p">(</span><span class="n">sig_str</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;σ&quot;</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">1e-12</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">allow_empty</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">strict_gt</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sigmas_ln</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;No valid σ for Log-Normal; returning.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">sln</span> <span class="ow">in</span> <span class="n">sigmas_ln</span><span class="p">:</span>
            <span class="n">param_sets</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;sigma_ln&quot;</span><span class="p">:</span> <span class="n">sln</span><span class="p">})</span>

    <span class="c1"># pre-load all component matrices on a shared energy grid</span>
    <span class="n">first</span> <span class="o">=</span> <span class="n">load_spectra_components</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">,</span> <span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">E_grid</span> <span class="o">=</span> <span class="n">first</span><span class="p">[</span><span class="s1">&#39;energy_primary&#39;</span><span class="p">]</span>
    <span class="n">logE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">E_grid</span><span class="p">)</span>
    <span class="n">N_M</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">masses</span><span class="p">)</span>

    <span class="n">direct_mat</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N_M</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">E_grid</span><span class="p">)))</span>
    <span class="n">secondary_mat</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">direct_mat</span><span class="p">)</span>
    <span class="n">inflight_mat</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">direct_mat</span><span class="p">)</span>
    <span class="n">final_mat</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">direct_mat</span><span class="p">)</span>
    <span class="n">Emax_ifa</span>       <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N_M</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">masses</span><span class="p">):</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">,</span> <span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">S</span> <span class="o">=</span> <span class="n">load_spectra_components</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>
        <span class="n">direct_mat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>    <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="s1">&#39;direct_gamma_primary&#39;</span><span class="p">]</span>
        <span class="n">secondary_mat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">E_grid</span><span class="p">,</span> <span class="n">S</span><span class="p">[</span><span class="s1">&#39;energy_secondary&#39;</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="s1">&#39;direct_gamma_secondary&#39;</span><span class="p">],</span> <span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">inflight_mat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="s1">&#39;IFA_primary&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">E_grid</span><span class="p">,</span> <span class="n">S</span><span class="p">[</span><span class="s1">&#39;energy_secondary&#39;</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="s1">&#39;IFA_secondary&#39;</span><span class="p">],</span> <span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">final_mat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>     <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="s1">&#39;FSR_primary&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">E_grid</span><span class="p">,</span> <span class="n">S</span><span class="p">[</span><span class="s1">&#39;energy_secondary&#39;</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="s1">&#39;FSR_secondary&#39;</span><span class="p">],</span> <span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">load_xy_lenient</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="s2">&quot;inflight_annihilation_prim.txt&quot;</span><span class="p">))</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">load_xy_lenient</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="s2">&quot;inflight_annihilation_sec.txt&quot;</span><span class="p">))</span>
        <span class="n">Emax_ifa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">p</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">size</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">size</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">logM_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">masses</span><span class="p">)</span>
    <span class="n">floor</span> <span class="o">=</span> <span class="mf">1e-300</span>

    <span class="n">ld</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">direct_mat</span>    <span class="o">&gt;</span> <span class="n">floor</span><span class="p">,</span> <span class="n">direct_mat</span><span class="p">,</span>     <span class="n">floor</span><span class="p">))</span>
    <span class="n">ls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">secondary_mat</span> <span class="o">&gt;</span> <span class="n">floor</span><span class="p">,</span> <span class="n">secondary_mat</span><span class="p">,</span>  <span class="n">floor</span><span class="p">))</span>
    <span class="n">li</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">inflight_mat</span>  <span class="o">&gt;</span> <span class="n">floor</span><span class="p">,</span> <span class="n">inflight_mat</span><span class="p">,</span>   <span class="n">floor</span><span class="p">))</span>
    <span class="n">lf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">final_mat</span>     <span class="o">&gt;</span> <span class="n">floor</span><span class="p">,</span> <span class="n">final_mat</span><span class="p">,</span>      <span class="n">floor</span><span class="p">))</span>

    <span class="n">sp_d</span> <span class="o">=</span> <span class="n">RectBivariateSpline</span><span class="p">(</span><span class="n">logM_all</span><span class="p">,</span> <span class="n">logE</span><span class="p">,</span> <span class="n">ld</span><span class="p">,</span> <span class="n">kx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ky</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">sp_s</span> <span class="o">=</span> <span class="n">RectBivariateSpline</span><span class="p">(</span><span class="n">logM_all</span><span class="p">,</span> <span class="n">logE</span><span class="p">,</span> <span class="n">ls</span><span class="p">,</span> <span class="n">kx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ky</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">sp_i</span> <span class="o">=</span> <span class="n">RectBivariateSpline</span><span class="p">(</span><span class="n">logM_all</span><span class="p">,</span> <span class="n">logE</span><span class="p">,</span> <span class="n">li</span><span class="p">,</span> <span class="n">kx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ky</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">sp_f</span> <span class="o">=</span> <span class="n">RectBivariateSpline</span><span class="p">(</span><span class="n">logM_all</span><span class="p">,</span> <span class="n">logE</span><span class="p">,</span> <span class="n">lf</span><span class="p">,</span> <span class="n">kx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ky</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">results</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">param_sets</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">is_g</span><span class="p">:</span>
            <span class="n">sigma_x</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;sigma_x&quot;</span><span class="p">]</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">1.30909</span><span class="p">,</span> <span class="mi">2000</span><span class="p">)</span>
            <span class="n">mf</span> <span class="o">=</span> <span class="n">mass_function</span><span class="p">(</span><span class="n">delta_l</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">3.3</span><span class="p">,</span> <span class="mf">0.59</span><span class="p">,</span> <span class="mf">0.36</span><span class="p">),</span> <span class="n">sigma_x</span><span class="p">,</span> <span class="mf">0.59</span><span class="p">,</span> <span class="mf">0.36</span><span class="p">)</span>
            <span class="n">label_param</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;σ=</span><span class="si">{</span><span class="n">sigma_x</span><span class="si">:</span><span class="s2">.3g</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">mf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">mf</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mf</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="n">mf</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mf</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Underlying PDF vanished for σ=</span><span class="si">{</span><span class="n">sigma_x</span><span class="si">:</span><span class="s2">g</span><span class="si">}</span><span class="s2">; skipping.&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">probabilities</span> <span class="o">=</span> <span class="n">mf</span> <span class="o">/</span> <span class="n">mf</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">r_mode</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">mf</span><span class="p">)]</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mf</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">elif</span> <span class="n">is_ng</span><span class="p">:</span>
            <span class="n">sigma_X</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;sigma_X&quot;</span><span class="p">];</span> <span class="n">ratio</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;ratio&quot;</span><span class="p">];</span> <span class="n">sigma_Y</span> <span class="o">=</span> <span class="n">ratio</span> <span class="o">*</span> <span class="n">sigma_X</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">1.30909</span><span class="p">,</span> <span class="mi">2000</span><span class="p">)</span>
            <span class="n">mf</span> <span class="o">=</span> <span class="n">mass_function_exact</span><span class="p">(</span><span class="n">delta_l</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">3.3</span><span class="p">,</span> <span class="mf">0.59</span><span class="p">,</span> <span class="mf">0.36</span><span class="p">),</span> <span class="n">sigma_X</span><span class="p">,</span> <span class="n">sigma_Y</span><span class="p">,</span> <span class="mf">0.59</span><span class="p">,</span> <span class="mf">0.36</span><span class="p">)</span>
            <span class="n">label_param</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;σX=</span><span class="si">{</span><span class="n">sigma_X</span><span class="si">:</span><span class="s2">.3g</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">mf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">mf</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mf</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="n">mf</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mf</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Underlying PDF vanished for σ_X=</span><span class="si">{</span><span class="n">sigma_X</span><span class="si">:</span><span class="s2">g</span><span class="si">}</span><span class="s2">; skipping.&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">probabilities</span> <span class="o">=</span> <span class="n">mf</span> <span class="o">/</span> <span class="n">mf</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">r_mode</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">mf</span><span class="p">)]</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mf</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># is_ln</span>
            <span class="n">sigma_ln</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;sigma_ln&quot;</span><span class="p">]</span>
            <span class="n">label_param</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;σ=</span><span class="si">{</span><span class="n">sigma_ln</span><span class="si">:</span><span class="s2">.3g</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">for</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">:</span>
            <span class="n">sum_d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">E_grid</span><span class="p">);</span> <span class="n">sum_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">E_grid</span><span class="p">)</span>
            <span class="n">sum_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">E_grid</span><span class="p">);</span> <span class="n">sum_f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">E_grid</span><span class="p">)</span>
            <span class="n">md</span>    <span class="o">=</span> <span class="p">[]</span>

            <span class="n">bar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">N_target</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Sampling  peak </span><span class="si">{</span><span class="n">peak</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">  [</span><span class="si">{</span><span class="n">label_param</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;BH&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">is_ln</span><span class="p">:</span>
                <span class="n">mu_eff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">peak</span><span class="p">)</span> <span class="o">+</span> <span class="n">sigma_ln</span><span class="o">**</span><span class="mi">2</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">masses_drawn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">lognormal</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="n">mu_eff</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma_ln</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">N_target</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">err</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sampling error (lognormal, peak </span><span class="si">{</span><span class="n">peak</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">, σ=</span><span class="si">{</span><span class="n">sigma_ln</span><span class="si">:</span><span class="s2">g</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Skipping.&quot;</span><span class="p">)</span>
                    <span class="n">bar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="k">continue</span>
                <span class="k">for</span> <span class="n">mraw</span> <span class="ow">in</span> <span class="n">masses_drawn</span><span class="p">:</span>
                    <span class="n">md</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">mraw</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">mraw</span> <span class="o">&lt;</span> <span class="n">MIN_MASS</span> <span class="ow">or</span> <span class="n">mraw</span> <span class="o">&gt;</span> <span class="n">MAX_MASS</span><span class="p">:</span>
                        <span class="n">d_vals</span> <span class="o">=</span> <span class="n">s_vals</span> <span class="o">=</span> <span class="n">i_vals</span> <span class="o">=</span> <span class="n">f_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">E_grid</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">snap</span> <span class="o">=</span> <span class="n">snap_to_available</span><span class="p">(</span><span class="n">mraw</span><span class="p">,</span> <span class="n">masses</span><span class="p">)</span>
                            <span class="n">mval</span> <span class="o">=</span> <span class="n">snap</span> <span class="k">if</span> <span class="n">snap</span> <span class="k">else</span> <span class="n">mraw</span>
                            <span class="n">idx_up</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">masses</span><span class="p">,</span> <span class="n">mval</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">))</span>
                            <span class="n">idx_low</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">idx_up</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                            <span class="n">idx_up</span>  <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">idx_up</span><span class="p">,</span> <span class="n">N_M</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                            <span class="n">Ecut</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">Emax_ifa</span><span class="p">[</span><span class="n">idx_low</span><span class="p">],</span> <span class="n">Emax_ifa</span><span class="p">[</span><span class="n">idx_up</span><span class="p">])</span>
                            <span class="n">logm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">mval</span><span class="p">)</span>
                            <span class="n">d_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">sp_d</span><span class="p">(</span><span class="n">logm</span><span class="p">,</span> <span class="n">logE</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
                            <span class="n">s_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">sp_s</span><span class="p">(</span><span class="n">logm</span><span class="p">,</span> <span class="n">logE</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
                            <span class="n">i_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">sp_i</span><span class="p">(</span><span class="n">logm</span><span class="p">,</span> <span class="n">logE</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
                            <span class="n">f_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">sp_f</span><span class="p">(</span><span class="n">logm</span><span class="p">,</span> <span class="n">logE</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Interpolation error at mass </span><span class="si">{</span><span class="n">mraw</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2"> g: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Skipping draw.&quot;</span><span class="p">)</span>
                            <span class="n">d_vals</span> <span class="o">=</span> <span class="n">s_vals</span> <span class="o">=</span> <span class="n">i_vals</span> <span class="o">=</span> <span class="n">f_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">E_grid</span><span class="p">)</span>
                        <span class="c1"># guard inflight tails</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">i_vals</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">i_vals</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">i_vals</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">):</span> <span class="n">i_vals</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                            <span class="k">else</span><span class="p">:</span> <span class="k">break</span>
                        <span class="n">log10i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">i_vals</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="n">i_vals</span><span class="p">,</span> <span class="n">floor</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">log10i</span><span class="p">)):</span>
                            <span class="k">if</span> <span class="n">log10i</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">log10i</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">50</span><span class="p">:</span>
                                <span class="n">i_vals</span><span class="p">[</span><span class="n">j</span><span class="p">:]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span> <span class="k">break</span>
                        <span class="n">i_vals</span><span class="p">[</span><span class="n">E_grid</span> <span class="o">&gt;=</span> <span class="n">Ecut</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="n">sum_d</span> <span class="o">+=</span> <span class="n">d_vals</span><span class="p">;</span> <span class="n">sum_s</span> <span class="o">+=</span> <span class="n">s_vals</span><span class="p">;</span> <span class="n">sum_i</span> <span class="o">+=</span> <span class="n">i_vals</span><span class="p">;</span> <span class="n">sum_f</span> <span class="o">+=</span> <span class="n">f_vals</span>
                    <span class="n">bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">scale</span> <span class="o">=</span> <span class="n">peak</span> <span class="o">/</span> <span class="n">r_mode</span>
                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_target</span><span class="p">):</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">probabilities</span><span class="p">)</span>
                    <span class="n">mraw</span> <span class="o">=</span> <span class="n">r</span> <span class="o">*</span> <span class="n">scale</span>
                    <span class="n">md</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mraw</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">mraw</span> <span class="o">&lt;</span> <span class="n">MIN_MASS</span> <span class="ow">or</span> <span class="n">mraw</span> <span class="o">&gt;</span> <span class="n">MAX_MASS</span><span class="p">:</span>
                        <span class="n">d_vals</span> <span class="o">=</span> <span class="n">s_vals</span> <span class="o">=</span> <span class="n">i_vals</span> <span class="o">=</span> <span class="n">f_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">E_grid</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">snap</span> <span class="o">=</span> <span class="n">snap_to_available</span><span class="p">(</span><span class="n">mraw</span><span class="p">,</span> <span class="n">masses</span><span class="p">)</span>
                            <span class="n">mval</span> <span class="o">=</span> <span class="n">snap</span> <span class="k">if</span> <span class="n">snap</span> <span class="k">else</span> <span class="n">mraw</span>
                            <span class="n">idx_up</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">masses</span><span class="p">,</span> <span class="n">mval</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">))</span>
                            <span class="n">idx_low</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">idx_up</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                            <span class="n">idx_up</span>  <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">idx_up</span><span class="p">,</span> <span class="n">N_M</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                            <span class="n">Ecut</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">Emax_ifa</span><span class="p">[</span><span class="n">idx_low</span><span class="p">],</span> <span class="n">Emax_ifa</span><span class="p">[</span><span class="n">idx_up</span><span class="p">])</span>
                            <span class="n">logm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">mval</span><span class="p">)</span>
                            <span class="n">d_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">sp_d</span><span class="p">(</span><span class="n">logm</span><span class="p">,</span> <span class="n">logE</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
                            <span class="n">s_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">sp_s</span><span class="p">(</span><span class="n">logm</span><span class="p">,</span> <span class="n">logE</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
                            <span class="n">i_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">sp_i</span><span class="p">(</span><span class="n">logm</span><span class="p">,</span> <span class="n">logE</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
                            <span class="n">f_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">sp_f</span><span class="p">(</span><span class="n">logm</span><span class="p">,</span> <span class="n">logE</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Interpolation error at mass </span><span class="si">{</span><span class="n">mraw</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2"> g: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Skipping draw.&quot;</span><span class="p">)</span>
                            <span class="n">d_vals</span> <span class="o">=</span> <span class="n">s_vals</span> <span class="o">=</span> <span class="n">i_vals</span> <span class="o">=</span> <span class="n">f_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">E_grid</span><span class="p">)</span>
                        <span class="c1"># guard inflight tails</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">i_vals</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">i_vals</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">i_vals</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">):</span> <span class="n">i_vals</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                            <span class="k">else</span><span class="p">:</span> <span class="k">break</span>
                        <span class="n">log10i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">i_vals</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="n">i_vals</span><span class="p">,</span> <span class="n">floor</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">log10i</span><span class="p">)):</span>
                            <span class="k">if</span> <span class="n">log10i</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">log10i</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">50</span><span class="p">:</span>
                                <span class="n">i_vals</span><span class="p">[</span><span class="n">j</span><span class="p">:]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span> <span class="k">break</span>
                        <span class="n">i_vals</span><span class="p">[</span><span class="n">E_grid</span> <span class="o">&gt;=</span> <span class="n">Ecut</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="n">sum_d</span> <span class="o">+=</span> <span class="n">d_vals</span><span class="p">;</span> <span class="n">sum_s</span> <span class="o">+=</span> <span class="n">s_vals</span><span class="p">;</span> <span class="n">sum_i</span> <span class="o">+=</span> <span class="n">i_vals</span><span class="p">;</span> <span class="n">sum_f</span> <span class="o">+=</span> <span class="n">f_vals</span>
                    <span class="n">bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">bar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="n">avg_d</span> <span class="o">=</span> <span class="n">sum_d</span> <span class="o">/</span> <span class="n">N_target</span><span class="p">;</span> <span class="n">avg_s</span> <span class="o">=</span> <span class="n">sum_s</span> <span class="o">/</span> <span class="n">N_target</span>
            <span class="n">avg_i</span> <span class="o">=</span> <span class="n">sum_i</span> <span class="o">/</span> <span class="n">N_target</span><span class="p">;</span> <span class="n">avg_f</span> <span class="o">=</span> <span class="n">sum_f</span> <span class="o">/</span> <span class="n">N_target</span>
            <span class="n">avg_tot</span> <span class="o">=</span> <span class="n">avg_d</span> <span class="o">+</span> <span class="n">avg_s</span> <span class="o">+</span> <span class="n">avg_i</span> <span class="o">+</span> <span class="n">avg_f</span>
            <span class="n">tol</span> <span class="o">=</span> <span class="mf">1e-299</span>
            <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="p">(</span><span class="n">avg_d</span><span class="p">,</span> <span class="n">avg_s</span><span class="p">,</span> <span class="n">avg_i</span><span class="p">,</span> <span class="n">avg_f</span><span class="p">,</span> <span class="n">avg_tot</span><span class="p">):</span>
                <span class="n">arr</span><span class="p">[</span><span class="n">arr</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;gaussian&quot;</span> <span class="k">if</span> <span class="n">is_g</span> <span class="k">else</span> <span class="s2">&quot;non_gaussian&quot;</span> <span class="k">if</span> <span class="n">is_ng</span> <span class="k">else</span> <span class="s2">&quot;lognormal&quot;</span><span class="p">),</span>
                <span class="s2">&quot;peak&quot;</span><span class="p">:</span> <span class="n">peak</span><span class="p">,</span>
                <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">params</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                <span class="s2">&quot;E&quot;</span><span class="p">:</span> <span class="n">E_grid</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                <span class="s2">&quot;spectrum&quot;</span><span class="p">:</span> <span class="n">avg_tot</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                <span class="s2">&quot;mdist&quot;</span><span class="p">:</span> <span class="n">md</span><span class="p">[:],</span>
                <span class="s2">&quot;label_param&quot;</span><span class="p">:</span> <span class="n">label_param</span><span class="p">,</span>
                <span class="s2">&quot;nsamp&quot;</span><span class="p">:</span> <span class="n">N_target</span>
            <span class="p">})</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">results</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># dN/dE overlays</span>
    <span class="n">fig1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
    <span class="n">peaks_dn</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;E&quot;</span><span class="p">];</span> <span class="n">sp</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;spectrum&quot;</span><span class="p">];</span> <span class="n">m</span> <span class="o">=</span> <span class="n">sp</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="n">sp</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                 <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">distribution_method</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;peak&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1e</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;label_param&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;σ=&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;σX=&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">peaks_dn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$E_\gamma$ (MeV)&#39;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$dN_\gamma/dE_\gamma$&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">peaks_dn</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">peaks_dn</span><span class="p">)</span><span class="o">/</span><span class="mf">1e3</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">peaks_dn</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">5e3</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Comparison: dN/dE&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig1</span><span class="p">)</span>

    <span class="c1"># E^2 dN/dE overlays</span>
    <span class="n">fig2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
    <span class="n">peaks_e2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;E&quot;</span><span class="p">];</span> <span class="n">sp</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;spectrum&quot;</span><span class="p">];</span> <span class="n">m</span> <span class="o">=</span> <span class="n">sp</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="n">E</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sp</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                 <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">distribution_method</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;peak&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1e</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;label_param&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;σ=&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;σX=&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">peaks_e2</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">E</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sp</span><span class="p">[</span><span class="n">m</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">else</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$E_\gamma$ (MeV)&#39;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$E^2\,dN_\gamma/dE_\gamma$&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">peaks_e2</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">peaks_e2</span><span class="p">)</span><span class="o">/</span><span class="mf">1e3</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">peaks_e2</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">5e3</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Comparison: $E^2$ dN/dE&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig2</span><span class="p">)</span>

    <span class="c1"># Histograms + theoretical mass-PDF overlays (in counts space)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_hist_common_bins</span><span class="p">(</span><span class="n">md</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute histogram bins via Freedman–Diaconis, clamped to [1,50].&quot;&quot;&quot;</span>
        <span class="n">md</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">md</span> <span class="o">=</span> <span class="n">md</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">md</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">md</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="p">(</span><span class="n">md</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">md</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">==</span> <span class="n">md</span><span class="o">.</span><span class="n">max</span><span class="p">()):</span>
            <span class="n">center</span> <span class="o">=</span> <span class="n">md</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">md</span><span class="o">.</span><span class="n">size</span> <span class="k">else</span> <span class="mf">0.0</span>
            <span class="n">eps</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">center</span><span class="p">)</span><span class="o">*</span><span class="mf">1e-9</span> <span class="k">if</span> <span class="n">center</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">1e-9</span>
            <span class="k">return</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">center</span> <span class="o">-</span> <span class="n">eps</span><span class="p">,</span> <span class="n">center</span> <span class="o">+</span> <span class="n">eps</span><span class="p">),</span> <span class="kc">None</span>
        <span class="n">q25</span><span class="p">,</span> <span class="n">q75</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">75</span><span class="p">])</span>
        <span class="n">iqr</span> <span class="o">=</span> <span class="n">q75</span> <span class="o">-</span> <span class="n">q25</span>
        <span class="k">if</span> <span class="n">iqr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">bw</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">iqr</span> <span class="o">*</span> <span class="n">md</span><span class="o">.</span><span class="n">size</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">k</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">md</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">md</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="n">bw</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">k</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">md</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">md</span>

    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span>
        <span class="n">figH</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>

        <span class="n">md</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;mdist&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">md</span> <span class="o">=</span> <span class="n">md</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">md</span><span class="p">)]</span>

        <span class="n">k</span><span class="p">,</span> <span class="n">fixed_range</span><span class="p">,</span> <span class="n">md_safe</span> <span class="o">=</span> <span class="n">_hist_common_bins</span><span class="p">(</span><span class="n">md</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fixed_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">fixed_range</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                                  <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">distribution_method</span><span class="si">}</span><span class="s1"> samples (</span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;label_param&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">md_safe</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                                  <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">distribution_method</span><span class="si">}</span><span class="s1"> samples (</span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;label_param&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

        <span class="n">bin_widths</span> <span class="o">=</span> <span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ref_width</span>  <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">bin_widths</span><span class="p">))</span> <span class="k">if</span> <span class="n">bin_widths</span><span class="o">.</span><span class="n">size</span> <span class="k">else</span> <span class="mf">1.0</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">:</span>
            <span class="n">sigma_x</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">][</span><span class="s2">&quot;sigma_x&quot;</span><span class="p">]</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">1.30909</span><span class="p">,</span> <span class="mi">2000</span><span class="p">)</span>
            <span class="n">mf</span> <span class="o">=</span> <span class="n">mass_function</span><span class="p">(</span><span class="n">delta_l</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">3.3</span><span class="p">,</span> <span class="mf">0.59</span><span class="p">,</span> <span class="mf">0.36</span><span class="p">),</span> <span class="n">sigma_x</span><span class="p">,</span> <span class="mf">0.59</span><span class="p">,</span> <span class="mf">0.36</span><span class="p">)</span>
            <span class="n">mf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">mf</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mf</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="n">mf</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mf</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">probabilities</span> <span class="o">=</span> <span class="n">mf</span> <span class="o">/</span> <span class="n">mf</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="n">r_mode</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">mf</span><span class="p">)]</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mf</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">scale</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;peak&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">r_mode</span>
                <span class="n">dx</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">dm</span> <span class="o">=</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">scale</span>
                <span class="n">pdf_mass</span> <span class="o">=</span> <span class="n">probabilities</span> <span class="o">/</span> <span class="n">dm</span>
                <span class="n">m_line</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">scale</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">m_line</span> <span class="o">&gt;=</span> <span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">m_line</span> <span class="o">&lt;=</span> <span class="n">bins</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">pdf_mass</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pdf_mass</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
                    <span class="n">y_line</span> <span class="o">=</span> <span class="n">pdf_mass</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">*</span> <span class="n">ref_width</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;mdist&quot;</span><span class="p">])</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">m_line</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">y_line</span><span class="p">,</span> <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Underlying PDF (counts)&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;non_gaussian&quot;</span><span class="p">:</span>
            <span class="n">sigma_X</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">][</span><span class="s2">&quot;sigma_X&quot;</span><span class="p">];</span> <span class="n">ratio</span> <span class="o">=</span> <span class="mf">0.75</span><span class="p">;</span> <span class="n">sigma_Y</span> <span class="o">=</span> <span class="n">ratio</span> <span class="o">*</span> <span class="n">sigma_X</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">1.30909</span><span class="p">,</span> <span class="mi">2000</span><span class="p">)</span>
            <span class="n">mf</span> <span class="o">=</span> <span class="n">mass_function_exact</span><span class="p">(</span><span class="n">delta_l</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">3.3</span><span class="p">,</span> <span class="mf">0.59</span><span class="p">,</span> <span class="mf">0.36</span><span class="p">),</span> <span class="n">sigma_X</span><span class="p">,</span> <span class="n">sigma_Y</span><span class="p">,</span> <span class="mf">0.59</span><span class="p">,</span> <span class="mf">0.36</span><span class="p">)</span>
            <span class="n">mf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">mf</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mf</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="n">mf</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mf</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">probabilities</span> <span class="o">=</span> <span class="n">mf</span> <span class="o">/</span> <span class="n">mf</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="n">r_mode</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">mf</span><span class="p">)]</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mf</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">scale</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;peak&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">r_mode</span>
                <span class="n">dx</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">dm</span> <span class="o">=</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">scale</span>
                <span class="n">pdf_mass</span> <span class="o">=</span> <span class="n">probabilities</span> <span class="o">/</span> <span class="n">dm</span>
                <span class="n">m_line</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">scale</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">m_line</span> <span class="o">&gt;=</span> <span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">m_line</span> <span class="o">&lt;=</span> <span class="n">bins</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">pdf_mass</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pdf_mass</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
                    <span class="n">y_line</span> <span class="o">=</span> <span class="n">pdf_mass</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">*</span> <span class="n">ref_width</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;mdist&quot;</span><span class="p">])</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">m_line</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">y_line</span><span class="p">,</span> <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Underlying PDF (counts)&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># lognormal</span>
            <span class="n">sigma_ln</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">][</span><span class="s2">&quot;sigma_ln&quot;</span><span class="p">];</span> <span class="n">mu_eff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;peak&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="n">sigma_ln</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">mlo_tail</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">mu_eff</span> <span class="o">-</span> <span class="mf">6.0</span><span class="o">*</span><span class="n">sigma_ln</span><span class="p">);</span> <span class="n">mhi_tail</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">mu_eff</span> <span class="o">+</span> <span class="mf">6.0</span><span class="o">*</span><span class="n">sigma_ln</span><span class="p">)</span>
            <span class="n">m_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mlo_tail</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">mhi_tail</span><span class="p">)),</span> <span class="mi">2000</span><span class="p">)</span>
            <span class="n">pdf</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="n">m_plot</span><span class="o">*</span><span class="n">sigma_ln</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="o">-</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">m_plot</span><span class="p">)</span><span class="o">-</span><span class="n">mu_eff</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sigma_ln</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
            <span class="n">y_plot</span> <span class="o">=</span> <span class="n">pdf</span> <span class="o">*</span> <span class="n">ref_width</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;mdist&quot;</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">m_plot</span><span class="p">,</span> <span class="n">y_plot</span><span class="p">,</span> <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Underlying PDF (counts)&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;σ=</span><span class="si">{</span><span class="n">sigma_ln</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Simulated PBH Mass (g)&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Count&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Mass Distribution &amp; PDF for Peak </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;peak&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1"> g&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">figH</span><span class="p">)</span>

    <span class="c1"># === Save distributed results ===</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">tosave</span> <span class="o">=</span> <span class="n">user_input</span><span class="p">(</span><span class="s2">&quot;Save distributed results? (y/n): &quot;</span><span class="p">,</span>
                            <span class="n">allow_back</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">allow_exit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">BackRequested</span><span class="p">:</span>
        <span class="n">tosave</span> <span class="o">=</span> <span class="s1">&#39;n&#39;</span>
    <span class="k">if</span> <span class="n">tosave</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;yes&#39;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">method</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">:</span>
                <span class="n">base</span> <span class="o">=</span> <span class="n">GAUSS_RESULTS_DIR</span>
                <span class="n">tag</span>  <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;peak_</span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;peak&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;label_param&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_N</span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;nsamp&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;non_gaussian&quot;</span><span class="p">:</span>
                <span class="n">base</span> <span class="o">=</span> <span class="n">NGAUSS_RESULTS_DIR</span>
                <span class="n">tag</span>  <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;peak_</span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;peak&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;label_param&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_N</span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;nsamp&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">base</span> <span class="o">=</span> <span class="n">LOGN_RESULTS_DIR</span>
                <span class="n">tag</span>  <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;peak_</span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;peak&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;label_param&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_N</span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;nsamp&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">outdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>
            <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">unique</span> <span class="o">=</span> <span class="n">outdir</span>
            <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">unique</span><span class="p">):</span>
                <span class="n">unique</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">outdir</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span> <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">unique</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unique</span><span class="p">,</span> <span class="s2">&quot;distributed_spectrum.txt&quot;</span><span class="p">),</span>
                       <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;E&quot;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;spectrum&quot;</span><span class="p">])),</span>
                       <span class="n">header</span><span class="o">=</span><span class="s2">&quot;E_gamma(MeV)   TotalSpectrum&quot;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%.10e</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unique</span><span class="p">,</span> <span class="s2">&quot;mass_distribution.txt&quot;</span><span class="p">),</span>
                       <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;mdist&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span>
                       <span class="n">header</span><span class="o">=</span><span class="s2">&quot;Sampled masses (g)&quot;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%.12e</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved → </span><span class="si">{</span><span class="n">unique</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<span class="c1"># ---------------------------</span>
<span class="c1"># Helpers for Custom Equation: safe eval + variable prompting</span>
<span class="c1"># ---------------------------</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_build_safe_numpy_namespace</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">SimpleNamespace</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build a restricted numpy-like namespace exposing only safe math functions.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    SimpleNamespace</span>
<span class="sd">        Object exposing e.g. log, exp, sqrt, sin/cos/tan, etc.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">safe_np</span> <span class="o">=</span> <span class="n">SimpleNamespace</span><span class="p">(</span>
        <span class="n">log</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">,</span> <span class="n">log10</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">,</span> <span class="n">log1p</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">,</span> <span class="n">exp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">,</span> <span class="n">sqrt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">,</span>
        <span class="n">sin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">,</span> <span class="n">cos</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">,</span> <span class="n">tan</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">,</span> <span class="n">arctan</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">,</span>
        <span class="nb">abs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">,</span> <span class="n">minimum</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">,</span> <span class="n">maximum</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">,</span> <span class="n">erf</span><span class="o">=</span><span class="n">erf</span><span class="p">,</span>
        <span class="n">pi</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">e</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">e</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">safe_np</span>


<span class="n">SAFE_FUNCS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;log&quot;</span><span class="p">,</span><span class="s2">&quot;log10&quot;</span><span class="p">,</span><span class="s2">&quot;log1p&quot;</span><span class="p">,</span><span class="s2">&quot;exp&quot;</span><span class="p">,</span><span class="s2">&quot;sqrt&quot;</span><span class="p">,</span><span class="s2">&quot;pow&quot;</span><span class="p">,</span><span class="s2">&quot;sin&quot;</span><span class="p">,</span><span class="s2">&quot;cos&quot;</span><span class="p">,</span><span class="s2">&quot;tan&quot;</span><span class="p">,</span><span class="s2">&quot;arctan&quot;</span><span class="p">,</span>
    <span class="s2">&quot;abs&quot;</span><span class="p">,</span><span class="s2">&quot;minimum&quot;</span><span class="p">,</span><span class="s2">&quot;maximum&quot;</span><span class="p">,</span><span class="s2">&quot;clip&quot;</span><span class="p">,</span><span class="s2">&quot;erf&quot;</span><span class="p">,</span><span class="s2">&quot;pi&quot;</span><span class="p">,</span><span class="s2">&quot;e&quot;</span><span class="p">,</span><span class="s2">&quot;m&quot;</span><span class="p">,</span><span class="s2">&quot;np&quot;</span><span class="p">,</span><span class="s2">&quot;numpy&quot;</span>
<span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_detect_custom_variables</span><span class="p">(</span><span class="n">expr</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Detect identifiers in a user expression that are not known safe names.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    expr : str</span>
<span class="sd">        RHS expression in variable `m` (grams).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list[str]</span>
<span class="sd">        Sorted names of variables that require values from the user.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Greek letters like &#39;μ&#39;,&#39;α&#39;,&#39;β&#39; are supported as identifiers.</span>
<span class="sd">    - Strings are stripped to avoid false positives.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">expr_wo_strings</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(</span><span class="se">\&quot;</span><span class="s2">.*?</span><span class="se">\&quot;</span><span class="s2">|&#39;.*?&#39;)&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">expr</span><span class="p">)</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\b[^\W\d]\w*\b&quot;</span><span class="p">,</span> <span class="n">expr_wo_strings</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">))</span>
    <span class="n">unknown</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tokens</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SAFE_FUNCS</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">unknown</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_prompt_variable_values</span><span class="p">(</span><span class="n">var_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prompt the user for each variable value. Accepts numeric expressions</span>
<span class="sd">    using pi, e, and np.*.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    var_names : list[str]</span>
<span class="sd">        Variables needing values.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict[str, float]</span>
<span class="sd">        Mapping from name → float value.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    BackRequested</span>
<span class="sd">        If the user backs out.</span>
<span class="sd">    SystemExit</span>
<span class="sd">        If the user exits.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">vals</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">safe_np</span> <span class="o">=</span> <span class="n">_build_safe_numpy_namespace</span><span class="p">()</span>
    <span class="n">num_ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;__builtins__&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;pi&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">e</span><span class="p">,</span> <span class="s2">&quot;np&quot;</span><span class="p">:</span> <span class="n">safe_np</span><span class="p">,</span> <span class="s2">&quot;numpy&quot;</span><span class="p">:</span> <span class="n">safe_np</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">var_names</span><span class="p">:</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">user_input</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Enter value for variable &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: &quot;</span><span class="p">,</span>
                               <span class="n">allow_back</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">allow_exit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;__builtins__&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span> <span class="n">num_ctx</span><span class="p">)</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="n">vals</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="n">BackRequested</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">SystemExit</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">err</span><span class="p">(</span><span class="s2">&quot;Could not parse value. Use a number or an expression like &#39;1e16&#39; or &#39;2*np.pi&#39;. Try again.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">vals</span>


<span class="c1"># ---------------------------</span>
<span class="c1"># Custom Mass PDF from user-entered EQUATION</span>
<span class="c1"># ---------------------------</span>
<div class="viewcode-block" id="custom_equation_pdf_tool">
<a class="viewcode-back" href="../../api/generated/gammapbh.cli.html#gammapbh.cli.custom_equation_pdf_tool">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">custom_equation_pdf_tool</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build a PBH mass PDF from a user-entered equation f(m, params...), normalize it per gram,</span>
<span class="sd">    sample N masses, accumulate ONLY the TOTAL spectrum, then show:</span>

<span class="sd">      (1) total dN/dE,</span>
<span class="sd">      (2) total E^2 dN/dE,</span>
<span class="sd">      (3) mass histogram (counts) with analytic PDF scaled to counts (log bins).</span>

<span class="sd">    Saved outputs (if requested)</span>
<span class="sd">    ----------------------------</span>
<span class="sd">    - equation.txt           : The expression and any variable values (commented).</span>
<span class="sd">    - samples_sorted.txt     : Sorted sampled masses (g).</span>
<span class="sd">    - distributed_spectrum.txt : Columns: E_gamma(MeV), TotalSpectrum</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - The expression must be a *right-hand-side* function of `m` (no &quot;f(m)=&quot; prefix needed).</span>
<span class="sd">    - Allowed functions: subset from numpy (log/exp/sqrt/sin/cos/tan/arctan/abs/clip/min/max/erf).</span>
<span class="sd">    - Variables unknown to the safe namespace will be auto-detected and prompted for.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Discover data domain</span>
    <span class="n">masses</span><span class="p">,</span> <span class="n">names</span> <span class="o">=</span> <span class="n">discover_mass_folders</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">masses</span><span class="p">:</span>
        <span class="n">M_MIN</span><span class="p">,</span> <span class="n">M_MAX</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">masses</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">masses</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">M_MIN</span><span class="p">,</span> <span class="n">M_MAX</span> <span class="o">=</span> <span class="mf">5e13</span><span class="p">,</span> <span class="mf">1e19</span>

    <span class="n">N_BINS</span> <span class="o">=</span> <span class="mi">50</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">log_edges</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">safe_eval_on_grid</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">m_grid</span><span class="p">,</span> <span class="n">user_vars</span><span class="p">):</span>
        <span class="n">safe_np</span> <span class="o">=</span> <span class="n">_build_safe_numpy_namespace</span><span class="p">()</span>
        <span class="n">safe</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;m&quot;</span><span class="p">:</span> <span class="n">m_grid</span><span class="p">,</span>
            <span class="s2">&quot;log&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">,</span> <span class="s2">&quot;log10&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">,</span> <span class="s2">&quot;log1p&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">,</span>
            <span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">,</span> <span class="s2">&quot;sqrt&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">,</span> <span class="s2">&quot;pow&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">,</span>
            <span class="s2">&quot;sin&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">,</span> <span class="s2">&quot;cos&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">,</span> <span class="s2">&quot;tan&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">,</span> <span class="s2">&quot;arctan&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">,</span>
            <span class="s2">&quot;abs&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">,</span> <span class="s2">&quot;minimum&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">,</span> <span class="s2">&quot;maximum&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">,</span> <span class="s2">&quot;clip&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">,</span>
            <span class="s2">&quot;erf&quot;</span><span class="p">:</span> <span class="n">erf</span><span class="p">,</span> <span class="s2">&quot;pi&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">e</span><span class="p">,</span>
            <span class="s2">&quot;np&quot;</span><span class="p">:</span> <span class="n">safe_np</span><span class="p">,</span> <span class="s2">&quot;numpy&quot;</span><span class="p">:</span> <span class="n">safe_np</span>
        <span class="p">}</span>
        <span class="n">safe</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">user_vars</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;__builtins__&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span> <span class="n">safe</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">BackRequested</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">SystemExit</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not evaluate expression: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">y</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">m_grid</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">m_grid</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Expression did not return an array of the same shape as m.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">y</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">cdf_from_pdf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">pdf</span><span class="p">):</span>
        <span class="n">cdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">pdf</span><span class="p">)</span>
        <span class="n">cdf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">dm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="n">cdf</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">pdf</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">pdf</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">dm</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">cdf</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">total</span><span class="p">)</span> <span class="ow">or</span> <span class="n">total</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;PDF integrates to non-positive value.&quot;</span><span class="p">)</span>
        <span class="n">cdf</span> <span class="o">/=</span> <span class="n">total</span>
        <span class="k">return</span> <span class="n">cdf</span>

    <span class="c1"># ---- read the equation &amp; prompt variables ----</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Custom Equation Mass PDF ===&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Domain: m in [</span><span class="si">{:.2e}</span><span class="s2">, </span><span class="si">{:.2e}</span><span class="s2">] g&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">M_MIN</span><span class="p">,</span> <span class="n">M_MAX</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Enter a Python expression for your PDF f(m) using &#39;m&#39; in grams and any constants/variables you define.&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Examples:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;f(m) = (m/mp)**(-(alpha0 + beta*log(m/mp))) / m&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;f(m) = exp(-m/5e17) / m&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">user_input</span><span class="p">(</span><span class="s2">&quot;f(m) = &quot;</span><span class="p">,</span> <span class="n">allow_back</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">allow_exit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">BackRequested</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># If someone pastes &quot;f(m) = ...&quot; or &quot;fm = ...&quot;, strip the prefix anyway.</span>
    <span class="n">expr</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\s*(?:f\s*\(\s*m\s*\)|fm)\s*=\s*&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>

    <span class="c1"># Detect custom variables (excluding allowed function names, m, pi, e, np, numpy)</span>
    <span class="n">vars_needed</span> <span class="o">=</span> <span class="n">_detect_custom_variables</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
    <span class="n">user_vars</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">vars_needed</span><span class="p">:</span>
        <span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Variables detected: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">vars_needed</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">user_vars</span> <span class="o">=</span> <span class="n">_prompt_variable_values</span><span class="p">(</span><span class="n">vars_needed</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">BackRequested</span><span class="p">:</span>
            <span class="k">return</span>

    <span class="c1"># ---- build normalized PDF on a fine m-grid ----</span>
    <span class="n">m_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">M_MIN</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">M_MAX</span><span class="p">),</span> <span class="mi">20000</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">safe_eval_on_grid</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">m_grid</span><span class="p">,</span> <span class="n">user_vars</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">BackRequested</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">err</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">return</span>

    <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">area</span> <span class="o">=</span> <span class="n">trapezoid</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">m_grid</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">area</span><span class="p">)</span> <span class="ow">or</span> <span class="n">area</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="n">err</span><span class="p">(</span><span class="s2">&quot;Your f(m) is nonpositive or non-integrable over the domain.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">pdf</span> <span class="o">=</span> <span class="n">f</span> <span class="o">/</span> <span class="n">area</span>  <span class="c1"># per gram</span>
    <span class="n">cdf</span> <span class="o">=</span> <span class="n">cdf_from_pdf</span><span class="p">(</span><span class="n">m_grid</span><span class="p">,</span> <span class="n">pdf</span><span class="p">)</span>

    <span class="c1"># ---- ask for N ----</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">n_default</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="n">n_str</span> <span class="o">=</span> <span class="n">user_input</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Enter target N (integer, e.g. 1000):  &quot;</span><span class="p">,</span>
                           <span class="n">allow_back</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">allow_exit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">n_str</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">N</span> <span class="o">=</span> <span class="n">n_default</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_str</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">N</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">err</span><span class="p">(</span><span class="s2">&quot;N must be &gt; 0.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
    <span class="k">except</span> <span class="n">BackRequested</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">err</span><span class="p">(</span><span class="s2">&quot;Invalid N (must be a positive integer).&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># ---- pre-load spectral grids &amp; splines ----</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">masses</span><span class="p">:</span>
        <span class="n">err</span><span class="p">(</span><span class="s2">&quot;No valid mass folders found under the data directory.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">first</span> <span class="o">=</span> <span class="n">load_spectra_components</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">,</span> <span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">E_grid</span> <span class="o">=</span> <span class="n">first</span><span class="p">[</span><span class="s1">&#39;energy_primary&#39;</span><span class="p">]</span>
    <span class="n">logE</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">E_grid</span><span class="p">)</span>
    <span class="n">N_M</span>    <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">masses</span><span class="p">)</span>

    <span class="n">direct_mat</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N_M</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">E_grid</span><span class="p">)))</span>
    <span class="n">secondary_mat</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">direct_mat</span><span class="p">)</span>
    <span class="n">inflight_mat</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">direct_mat</span><span class="p">)</span>
    <span class="n">final_mat</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">direct_mat</span><span class="p">)</span>
    <span class="n">Emax_ifa</span>       <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N_M</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">masses</span><span class="p">):</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">,</span> <span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">S</span> <span class="o">=</span> <span class="n">load_spectra_components</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>
        <span class="n">direct_mat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>    <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="s1">&#39;direct_gamma_primary&#39;</span><span class="p">]</span>
        <span class="n">secondary_mat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">E_grid</span><span class="p">,</span> <span class="n">S</span><span class="p">[</span><span class="s1">&#39;energy_secondary&#39;</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="s1">&#39;direct_gamma_secondary&#39;</span><span class="p">],</span> <span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">inflight_mat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="s1">&#39;IFA_primary&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">E_grid</span><span class="p">,</span> <span class="n">S</span><span class="p">[</span><span class="s1">&#39;energy_secondary&#39;</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="s1">&#39;IFA_secondary&#39;</span><span class="p">],</span> <span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">final_mat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>     <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="s1">&#39;FSR_primary&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">E_grid</span><span class="p">,</span> <span class="n">S</span><span class="p">[</span><span class="s1">&#39;energy_secondary&#39;</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="s1">&#39;FSR_secondary&#39;</span><span class="p">],</span> <span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">load_xy_lenient</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="s2">&quot;inflight_annihilation_prim.txt&quot;</span><span class="p">))</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">load_xy_lenient</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="s2">&quot;inflight_annihilation_sec.txt&quot;</span><span class="p">))</span>
        <span class="n">Emax_ifa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">p</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">size</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">size</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">logM_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">masses</span><span class="p">)</span>
    <span class="n">floor</span> <span class="o">=</span> <span class="mf">1e-300</span>
    <span class="n">ld</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">direct_mat</span>    <span class="o">&gt;</span> <span class="n">floor</span><span class="p">,</span> <span class="n">direct_mat</span><span class="p">,</span>     <span class="n">floor</span><span class="p">))</span>
    <span class="n">ls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">secondary_mat</span> <span class="o">&gt;</span> <span class="n">floor</span><span class="p">,</span> <span class="n">secondary_mat</span><span class="p">,</span>  <span class="n">floor</span><span class="p">))</span>
    <span class="n">li</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">inflight_mat</span>  <span class="o">&gt;</span> <span class="n">floor</span><span class="p">,</span> <span class="n">inflight_mat</span><span class="p">,</span>   <span class="n">floor</span><span class="p">))</span>
    <span class="n">lf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">final_mat</span>     <span class="o">&gt;</span> <span class="n">floor</span><span class="p">,</span> <span class="n">final_mat</span><span class="p">,</span>      <span class="n">floor</span><span class="p">))</span>

    <span class="n">sp_d</span> <span class="o">=</span> <span class="n">RectBivariateSpline</span><span class="p">(</span><span class="n">logM_all</span><span class="p">,</span> <span class="n">logE</span><span class="p">,</span> <span class="n">ld</span><span class="p">,</span> <span class="n">kx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ky</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">sp_s</span> <span class="o">=</span> <span class="n">RectBivariateSpline</span><span class="p">(</span><span class="n">logM_all</span><span class="p">,</span> <span class="n">logE</span><span class="p">,</span> <span class="n">ls</span><span class="p">,</span> <span class="n">kx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ky</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">sp_i</span> <span class="o">=</span> <span class="n">RectBivariateSpline</span><span class="p">(</span><span class="n">logM_all</span><span class="p">,</span> <span class="n">logE</span><span class="p">,</span> <span class="n">li</span><span class="p">,</span> <span class="n">kx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ky</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">sp_f</span> <span class="o">=</span> <span class="n">RectBivariateSpline</span><span class="p">(</span><span class="n">logM_all</span><span class="p">,</span> <span class="n">logE</span><span class="p">,</span> <span class="n">lf</span><span class="p">,</span> <span class="n">kx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ky</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># ---- sample masses via inverse CDF and accumulate ONLY total spectrum ----</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">()</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">cdf</span><span class="p">,</span> <span class="n">m_grid</span><span class="p">)</span>
    <span class="n">samples</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

    <span class="n">sum_tot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">E_grid</span><span class="p">)</span>

    <span class="n">bar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Sampling custom PDF&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;BH&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">mraw</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mraw</span> <span class="o">&lt;</span> <span class="n">masses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">mraw</span> <span class="o">&gt;</span> <span class="n">masses</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">snap</span> <span class="o">=</span> <span class="n">snap_to_available</span><span class="p">(</span><span class="n">mraw</span><span class="p">,</span> <span class="n">masses</span><span class="p">)</span>
            <span class="n">mval</span> <span class="o">=</span> <span class="n">snap</span> <span class="k">if</span> <span class="n">snap</span> <span class="k">else</span> <span class="n">mraw</span>
            <span class="n">idx_up</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">masses</span><span class="p">,</span> <span class="n">mval</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">))</span>
            <span class="n">idx_low</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">idx_up</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">idx_up</span>  <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">idx_up</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">masses</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">Ecut</span>    <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">Emax_ifa</span><span class="p">[</span><span class="n">idx_low</span><span class="p">],</span> <span class="n">Emax_ifa</span><span class="p">[</span><span class="n">idx_up</span><span class="p">])</span>
            <span class="n">logm</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">mval</span><span class="p">)</span>
            <span class="n">d_vals</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">sp_d</span><span class="p">(</span><span class="n">logm</span><span class="p">,</span> <span class="n">logE</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
            <span class="n">s_vals</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">sp_s</span><span class="p">(</span><span class="n">logm</span><span class="p">,</span> <span class="n">logE</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
            <span class="n">i_vals</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">sp_i</span><span class="p">(</span><span class="n">logm</span><span class="p">,</span> <span class="n">logE</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
            <span class="n">f_vals</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">sp_f</span><span class="p">(</span><span class="n">logm</span><span class="p">,</span> <span class="n">logE</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># trim inflight tails (stability)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">i_vals</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">i_vals</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">i_vals</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">):</span>
                <span class="n">i_vals</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="n">log10i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">i_vals</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i_vals</span><span class="p">,</span> <span class="n">floor</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">log10i</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">log10i</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">log10i</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">50</span><span class="p">:</span>
                <span class="n">i_vals</span><span class="p">[</span><span class="n">j</span><span class="p">:]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">break</span>
        <span class="n">i_vals</span><span class="p">[</span><span class="n">E_grid</span> <span class="o">&gt;=</span> <span class="n">Ecut</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">sum_tot</span> <span class="o">+=</span> <span class="p">(</span><span class="n">d_vals</span> <span class="o">+</span> <span class="n">s_vals</span> <span class="o">+</span> <span class="n">i_vals</span> <span class="o">+</span> <span class="n">f_vals</span><span class="p">)</span>
        <span class="n">bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">bar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">avg_tot</span> <span class="o">=</span> <span class="n">sum_tot</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">avg_tot</span><span class="p">[</span><span class="n">avg_tot</span> <span class="o">&lt;</span> <span class="mf">1e-299</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1"># ---- FIGURE A: total dN/dE ----</span>
    <span class="n">msk</span> <span class="o">=</span> <span class="n">avg_tot</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">E_grid</span><span class="p">[</span><span class="n">msk</span><span class="p">],</span> <span class="n">avg_tot</span><span class="p">[</span><span class="n">msk</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Total spectrum&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">5e3</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">msk</span><span class="p">):</span>
        <span class="n">peak</span> <span class="o">=</span> <span class="n">avg_tot</span><span class="p">[</span><span class="n">msk</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">peak</span><span class="o">/</span><span class="mf">1e3</span><span class="p">,</span> <span class="n">peak</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$E_\gamma$ (MeV)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$dN_\gamma/dE_\gamma$ (MeV$^{-1}$ s$^{-1}$)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Custom Equation — Total $dN/dE$&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># ---- FIGURE B: total E^2 dN/dE ----</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">msk</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">E_grid</span><span class="p">[</span><span class="n">msk</span><span class="p">],</span> <span class="p">(</span><span class="n">E_grid</span><span class="p">[</span><span class="n">msk</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">avg_tot</span><span class="p">[</span><span class="n">msk</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Total&quot;</span><span class="p">)</span>
        <span class="n">peak_e2</span> <span class="o">=</span> <span class="p">((</span><span class="n">E_grid</span><span class="p">[</span><span class="n">msk</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">avg_tot</span><span class="p">[</span><span class="n">msk</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">peak_e2</span><span class="o">/</span><span class="mf">1e3</span><span class="p">,</span> <span class="n">peak_e2</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">5e3</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$E_\gamma$ (MeV)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$E^2\,dN_\gamma/dE_\gamma$ (MeV s$^{-1}$)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Custom Equation — Total $E^2 dN/dE$&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># ---- FIGURE C: Mass histogram (counts) + SMOOTH analytic PDF scaled to counts ----</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="n">log_edges</span><span class="p">(</span><span class="n">masses</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">masses</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">N_BINS</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="c1"># Blue = sampled counts per (log) bin</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">edges</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
             <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Sampled counts per bin (N=</span><span class="si">{</span><span class="n">N</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="c1"># Orange = smooth line proportional to expected counts/bin for log bins:</span>
    <span class="c1"># expected counts in a narrow log bin: N * pdf(m) * m * d(ln m)</span>
    <span class="n">dln</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">masses</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">masses</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">/</span> <span class="n">N_BINS</span>
    <span class="n">counts_line</span> <span class="o">=</span> <span class="n">N</span> <span class="o">*</span> <span class="n">pdf</span> <span class="o">*</span> <span class="n">m_grid</span> <span class="o">*</span> <span class="n">dln</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">m_grid</span><span class="p">,</span> <span class="n">counts_line</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Analytic PDF (scaled to counts)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Mass m (g)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Count per bin&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Custom Equation — Mass Histogram (counts) + Smooth PDF overlay&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># ---- Save exactly 3 files for custom: equation, mass distribution, distributed spectrum ----</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sv</span> <span class="o">=</span> <span class="n">user_input</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Save this custom spectrum? (y/n): &quot;</span><span class="p">,</span>
                        <span class="n">allow_back</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">allow_exit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">BackRequested</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">sv</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;yes&#39;</span><span class="p">):</span>
        <span class="n">median_mass</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">samples</span><span class="p">))</span> <span class="k">if</span> <span class="n">samples</span><span class="o">.</span><span class="n">size</span> <span class="k">else</span> <span class="mf">0.0</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">median_mass</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">_custom_eq&quot;</span>
        <span class="n">outdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CUSTOM_RESULTS_DIR</span><span class="p">,</span> <span class="n">folder</span><span class="p">)</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">outdir</span><span class="p">;</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outdir</span><span class="p">):</span>
            <span class="n">outdir</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span> <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s2">&quot;equation.txt&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">user_vars</span><span class="p">:</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# Variables:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">kname</span><span class="p">,</span> <span class="n">kval</span> <span class="ow">in</span> <span class="n">user_vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# </span><span class="si">{</span><span class="n">kname</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">kval</span><span class="si">:</span><span class="s2">.10e</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">expr</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s2">&quot;samples_sorted.txt&quot;</span><span class="p">),</span> <span class="n">samples</span><span class="p">,</span>
                   <span class="n">header</span><span class="o">=</span><span class="s2">&quot;Simulated masses (g), sorted ascending&quot;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%.12e</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s2">&quot;distributed_spectrum.txt&quot;</span><span class="p">),</span>
                   <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">E_grid</span><span class="p">,</span> <span class="n">avg_tot</span><span class="p">)),</span>
                   <span class="n">header</span><span class="o">=</span><span class="s2">&quot;E_gamma(MeV)   TotalSpectrum&quot;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%.10e</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved → </span><span class="si">{</span><span class="n">outdir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<span class="c1"># ---------------------------</span>
<span class="c1"># View previous spectra (with queue)</span>
<span class="c1"># ---------------------------</span>
<div class="viewcode-block" id="view_previous_spectra">
<a class="viewcode-back" href="../../api/generated/gammapbh.cli.html#gammapbh.cli.view_previous_spectra">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">view_previous_spectra</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    View previously saved spectra with a queue:</span>
<span class="sd">      - Selecting items adds them to the queue only.</span>
<span class="sd">      - Press &#39;0&#39; to plot ALL queued items: spectra first (dN/dE, E^2 dN/dE), then histograms.</span>
<span class="sd">      - Queue auto-clears after plotting.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># --- allowed mono input range (use discovered data domain) ---</span>
    <span class="n">masses_all</span><span class="p">,</span> <span class="n">names_all</span> <span class="o">=</span> <span class="n">discover_mass_folders</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">masses_all</span><span class="p">:</span>
        <span class="n">M_MIN_MONO</span><span class="p">,</span> <span class="n">M_MAX_MONO</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">masses_all</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">masses_all</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">M_MIN_MONO</span><span class="p">,</span> <span class="n">M_MAX_MONO</span> <span class="o">=</span> <span class="mf">5e13</span><span class="p">,</span> <span class="mf">1e19</span>

    <span class="n">cat_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;1&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Monochromatic Distribution&quot;</span><span class="p">,</span> <span class="n">MONO_RESULTS_DIR</span><span class="p">,</span>  <span class="kc">None</span><span class="p">,</span>                          <span class="s2">&quot;mono&quot;</span><span class="p">),</span>
        <span class="s1">&#39;2&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">GAUSSIAN_METHOD</span><span class="p">,</span>             <span class="n">GAUSS_RESULTS_DIR</span><span class="p">,</span>  <span class="s2">&quot;distributed_spectrum.txt&quot;</span><span class="p">,</span>    <span class="s2">&quot;gaussian&quot;</span><span class="p">),</span>
        <span class="s1">&#39;3&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">NON_GAUSSIAN_METHOD</span><span class="p">,</span>         <span class="n">NGAUSS_RESULTS_DIR</span><span class="p">,</span> <span class="s2">&quot;distributed_spectrum.txt&quot;</span><span class="p">,</span>    <span class="s2">&quot;non_gaussian&quot;</span><span class="p">),</span>
        <span class="s1">&#39;4&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">LOGNORMAL_METHOD</span><span class="p">,</span>            <span class="n">LOGN_RESULTS_DIR</span><span class="p">,</span>   <span class="s2">&quot;distributed_spectrum.txt&quot;</span><span class="p">,</span>    <span class="s2">&quot;lognormal&quot;</span><span class="p">),</span>
        <span class="s1">&#39;5&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Custom equation (user-defined mass PDF)&quot;</span><span class="p">,</span> <span class="n">CUSTOM_RESULTS_DIR</span><span class="p">,</span> <span class="s2">&quot;distributed_spectrum.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;custom&quot;</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="c1"># ---------- helpers: text cleanup &amp; equation parsing ----------</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_strip_invisibles</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\ufeff</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="se">\u200b</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="se">\u200c</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="se">\u200d</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="se">\u2060</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="se">\u200e</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="se">\u200f</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="se">\u202a</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="se">\u202b</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="se">\u202c</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="se">\u202d</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="se">\u202e</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="se">\u202f</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="se">\u00a0</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span>
        <span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_normalize_expr_line</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">_strip_invisibles</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\s*(?:f\s*\(\s*m\s*\)|fm)\s*=\s*&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;^&#39;</span><span class="p">,</span><span class="s1">&#39;**&#39;</span><span class="p">)</span>
               <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;×&#39;</span><span class="p">,</span><span class="s1">&#39;*&#39;</span><span class="p">)</span>
               <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;·&#39;</span><span class="p">,</span><span class="s1">&#39;*&#39;</span><span class="p">)</span>
               <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;÷&#39;</span><span class="p">,</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
               <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;−&#39;</span><span class="p">,</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
               <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;—&#39;</span><span class="p">,</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
               <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;–&#39;</span><span class="p">,</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
               <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;“&#39;</span><span class="p">,</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;”&#39;</span><span class="p">,</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
               <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;’&#39;</span><span class="p">,</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;‘&#39;</span><span class="p">,</span><span class="s2">&quot;&#39;&quot;</span><span class="p">))</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">in_sin</span><span class="p">,</span> <span class="n">in_dbl</span> <span class="o">=</span> <span class="p">[],</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;&#39;&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">in_dbl</span><span class="p">:</span>
                <span class="n">in_sin</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">in_sin</span>
            <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="s1">&#39;&quot;&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">in_sin</span><span class="p">:</span>
                <span class="n">in_dbl</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">in_dbl</span>
            <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s1">&#39;#&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">in_sin</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">in_dbl</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_read_equation_file</span><span class="p">(</span><span class="n">run_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
        <span class="n">eq_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="s2">&quot;equation.txt&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">eq_path</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8-sig&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">eq_path</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;latin-1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot read equation.txt: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">user_vars</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">raw</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">_strip_invisibles</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="s2">&quot;=&quot;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">user_vars</span><span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">_strip_invisibles</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">continue</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">_normalize_expr_line</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">norm</span><span class="p">:</span>
                <span class="n">expr</span> <span class="o">=</span> <span class="n">norm</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">raw</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">s</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">):</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">_normalize_expr_line</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
                        <span class="n">expr</span> <span class="o">=</span> <span class="n">s</span>
                        <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No custom equation found in equation.txt.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">expr</span><span class="p">,</span> <span class="n">user_vars</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_safe_eval_on_grid</span><span class="p">(</span><span class="n">expr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">m_grid</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">user_vars</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="n">safe_np</span> <span class="o">=</span> <span class="n">_build_safe_numpy_namespace</span><span class="p">()</span>
        <span class="n">safe</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;m&quot;</span><span class="p">:</span> <span class="n">m_grid</span><span class="p">,</span>
            <span class="s2">&quot;log&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">,</span> <span class="s2">&quot;log10&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">,</span> <span class="s2">&quot;log1p&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">,</span>
            <span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">,</span> <span class="s2">&quot;sqrt&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">,</span> <span class="s2">&quot;pow&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">,</span>
            <span class="s2">&quot;sin&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">,</span> <span class="s2">&quot;cos&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">,</span> <span class="s2">&quot;tan&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">,</span> <span class="s2">&quot;arctan&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">,</span>
            <span class="s2">&quot;abs&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">,</span> <span class="s2">&quot;minimum&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">,</span> <span class="s2">&quot;maximum&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">,</span> <span class="s2">&quot;clip&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">,</span>
            <span class="s2">&quot;erf&quot;</span><span class="p">:</span> <span class="n">erf</span><span class="p">,</span> <span class="s2">&quot;pi&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">e</span><span class="p">,</span>
            <span class="s2">&quot;np&quot;</span><span class="p">:</span> <span class="n">_build_safe_numpy_namespace</span><span class="p">(),</span> <span class="s2">&quot;numpy&quot;</span><span class="p">:</span> <span class="n">_build_safe_numpy_namespace</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="n">safe</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">user_vars</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;__builtins__&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span> <span class="n">safe</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">y</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">m_grid</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">m_grid</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Expression did not return an array of the same shape as m.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">y</span>

    <span class="c1"># ---------- parse run_name for peak and sigma ----------</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_peak_sigma</span><span class="p">(</span><span class="n">run_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="n">peak_val</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">sigma_val</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">sigma_str</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">m_peak</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;peak_([0-9.+\-eE]+)&quot;</span><span class="p">,</span> <span class="n">run_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m_peak</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">peak_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">m_peak</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">peak_val</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;non_gaussian&quot;</span><span class="p">:</span>
            <span class="n">m_sigx</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;σX([0-9.]+)&quot;</span><span class="p">,</span> <span class="n">run_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">m_sigx</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">sigma_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">m_sigx</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">sigma_val</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">sigma_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;σX=</span><span class="si">{</span><span class="n">sigma_val</span><span class="si">:</span><span class="s2">.3g</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">sigma_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;σX=?&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">m_sig</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;σ([0-9.]+)&quot;</span><span class="p">,</span> <span class="n">run_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">m_sig</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">sigma_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">m_sig</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">sigma_val</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">sigma_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;σ=</span><span class="si">{</span><span class="n">sigma_val</span><span class="si">:</span><span class="s2">.3g</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">sigma_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;σ=?&quot;</span>
        <span class="k">return</span> <span class="n">peak_val</span><span class="p">,</span> <span class="n">sigma_val</span><span class="p">,</span> <span class="n">sigma_str</span>

    <span class="c1"># ---------- plotting helpers (updated sizes) ----------</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_dn</span><span class="p">(</span><span class="n">results</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">results</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
        <span class="n">peaks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">lab</span><span class="p">,</span> <span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">S</span><span class="p">)</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">msk</span> <span class="o">=</span> <span class="n">S</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="n">msk</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="n">msk</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">lab</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">msk</span><span class="p">):</span>
                <span class="n">peaks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">S</span><span class="p">[</span><span class="n">msk</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$E_\gamma$ (MeV)&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$dN_\gamma/dE_\gamma$&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">peaks</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">peaks</span><span class="p">)</span><span class="o">/</span><span class="mf">1e3</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">peaks</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">5e3</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Comparison: dN/dE&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_e2</span><span class="p">(</span><span class="n">results</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">results</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
        <span class="n">peaks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">lab</span><span class="p">,</span> <span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">S</span><span class="p">)</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">msk</span> <span class="o">=</span> <span class="n">S</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="n">msk</span><span class="p">],</span> <span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="n">msk</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">S</span><span class="p">[</span><span class="n">msk</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">lab</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">msk</span><span class="p">):</span>
                <span class="n">peaks</span><span class="o">.</span><span class="n">append</span><span class="p">(((</span><span class="n">E</span><span class="p">[</span><span class="n">msk</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">S</span><span class="p">[</span><span class="n">msk</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$E_\gamma$ (MeV)&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$E^2\,dN_\gamma/dE_\gamma$&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">peaks</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">peaks</span><span class="p">)</span><span class="o">/</span><span class="mf">1e3</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">peaks</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">5e3</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Comparison: $E^2$ dN/dE&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_hist_gaussian</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">sigma_x</span><span class="p">,</span> <span class="n">title_prefix</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Histogram + counts-scaled Gaussian-collapse PDF overlay (bigger figure).&quot;&quot;&quot;</span>
        <span class="n">md</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">md</span> <span class="o">=</span> <span class="n">md</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">md</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">md</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>  <span class="c1"># &lt;-- bigger now</span>
        <span class="k">if</span> <span class="n">md</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">md</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">==</span> <span class="n">md</span><span class="o">.</span><span class="n">max</span><span class="p">():</span>
            <span class="n">center</span> <span class="o">=</span> <span class="n">md</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">eps</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">center</span><span class="p">)</span><span class="o">*</span><span class="mf">1e-9</span> <span class="k">if</span> <span class="n">center</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">1e-9</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="n">center</span><span class="o">-</span><span class="n">eps</span><span class="p">,</span> <span class="n">center</span><span class="o">+</span><span class="n">eps</span><span class="p">),</span>
                                  <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;samples&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">q25</span><span class="p">,</span> <span class="n">q75</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">75</span><span class="p">])</span>
            <span class="n">iqr</span> <span class="o">=</span> <span class="n">q75</span> <span class="o">-</span> <span class="n">q25</span>
            <span class="k">if</span> <span class="n">iqr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">bw</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">iqr</span> <span class="o">*</span> <span class="n">md</span><span class="o">.</span><span class="n">size</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">k</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">md</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">md</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="n">bw</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">k</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">md</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;samples&#39;</span><span class="p">)</span>

        <span class="n">x</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">1.30909</span><span class="p">,</span> <span class="mi">2000</span><span class="p">)</span>
        <span class="n">mf</span> <span class="o">=</span> <span class="n">mass_function</span><span class="p">(</span><span class="n">delta_l</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mf">3.3</span><span class="p">,</span><span class="mf">0.59</span><span class="p">,</span><span class="mf">0.36</span><span class="p">),</span> <span class="n">sigma_x</span><span class="p">,</span> <span class="mf">0.59</span><span class="p">,</span> <span class="mf">0.36</span><span class="p">)</span>
        <span class="n">mf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">mf</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mf</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">),</span> <span class="n">mf</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mf</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">probabilities</span> <span class="o">=</span> <span class="n">mf</span> <span class="o">/</span> <span class="n">mf</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">r_mode</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">mf</span><span class="p">)]</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mf</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="n">peak</span> <span class="o">/</span> <span class="n">r_mode</span> <span class="k">if</span> <span class="n">peak</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mf">1.0</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dm</span> <span class="o">=</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">scale</span>
            <span class="n">pdf_mass</span> <span class="o">=</span> <span class="n">probabilities</span> <span class="o">/</span> <span class="n">dm</span>
            <span class="n">m_line</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">scale</span>
            <span class="n">bin_widths</span> <span class="o">=</span> <span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">ref_width</span>  <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">bin_widths</span><span class="p">))</span> <span class="k">if</span> <span class="n">bin_widths</span><span class="o">.</span><span class="n">size</span> <span class="k">else</span> <span class="mf">1.0</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">m_line</span> <span class="o">&gt;=</span> <span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">m_line</span> <span class="o">&lt;=</span> <span class="n">bins</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">pdf_mass</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pdf_mass</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
                <span class="n">y_line</span> <span class="o">=</span> <span class="n">pdf_mass</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">*</span> <span class="n">ref_width</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">md</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">m_line</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">y_line</span><span class="p">,</span> <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                         <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Underlying PDF (counts)&#39;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Simulated PBH Mass (g)&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Count&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">title_prefix</span><span class="si">}</span><span class="s1"> — Mass Distribution &amp; PDF overlay&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_hist_nongaussian</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">sigma_X</span><span class="p">,</span> <span class="n">title_prefix</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Histogram + counts-scaled Non-Gaussian PDF overlay (bigger figure).&quot;&quot;&quot;</span>
        <span class="n">md</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">md</span> <span class="o">=</span> <span class="n">md</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">md</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">md</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>  <span class="c1"># &lt;-- bigger now</span>
        <span class="k">if</span> <span class="n">md</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">md</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">==</span> <span class="n">md</span><span class="o">.</span><span class="n">max</span><span class="p">():</span>
            <span class="n">center</span> <span class="o">=</span> <span class="n">md</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">eps</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">center</span><span class="p">)</span><span class="o">*</span><span class="mf">1e-9</span> <span class="k">if</span> <span class="n">center</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">1e-9</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="n">center</span><span class="o">-</span><span class="n">eps</span><span class="p">,</span> <span class="n">center</span><span class="o">+</span><span class="n">eps</span><span class="p">),</span>
                                  <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;samples&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">q25</span><span class="p">,</span> <span class="n">q75</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">75</span><span class="p">])</span>
            <span class="n">iqr</span> <span class="o">=</span> <span class="n">q75</span> <span class="o">-</span> <span class="n">q25</span>
            <span class="k">if</span> <span class="n">iqr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">bw</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">iqr</span> <span class="o">*</span> <span class="n">md</span><span class="o">.</span><span class="n">size</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">k</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">md</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">md</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="n">bw</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">k</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">md</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;samples&#39;</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">1.30909</span><span class="p">,</span> <span class="mi">2000</span><span class="p">)</span>
        <span class="n">sigma_Y</span> <span class="o">=</span> <span class="mf">0.75</span> <span class="o">*</span> <span class="p">(</span><span class="n">sigma_X</span> <span class="k">if</span> <span class="n">sigma_X</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">mf</span> <span class="o">=</span> <span class="n">mass_function_exact</span><span class="p">(</span><span class="n">delta_l</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mf">3.3</span><span class="p">,</span><span class="mf">0.59</span><span class="p">,</span><span class="mf">0.36</span><span class="p">),</span>
                                 <span class="n">sigma_X</span> <span class="k">if</span> <span class="n">sigma_X</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mf">0.0</span><span class="p">,</span>
                                 <span class="n">sigma_Y</span><span class="p">,</span>
                                 <span class="mf">0.59</span><span class="p">,</span> <span class="mf">0.36</span><span class="p">)</span>
        <span class="n">mf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">mf</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mf</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">),</span> <span class="n">mf</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mf</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">probabilities</span> <span class="o">=</span> <span class="n">mf</span> <span class="o">/</span> <span class="n">mf</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">r_mode</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">mf</span><span class="p">)]</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mf</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="n">peak</span> <span class="o">/</span> <span class="n">r_mode</span> <span class="k">if</span> <span class="n">peak</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mf">1.0</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dm</span> <span class="o">=</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">scale</span>
            <span class="n">pdf_mass</span> <span class="o">=</span> <span class="n">probabilities</span> <span class="o">/</span> <span class="n">dm</span>
            <span class="n">m_line</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">scale</span>
            <span class="n">bin_widths</span> <span class="o">=</span> <span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">ref_width</span>  <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">bin_widths</span><span class="p">))</span> <span class="k">if</span> <span class="n">bin_widths</span><span class="o">.</span><span class="n">size</span> <span class="k">else</span> <span class="mf">1.0</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">m_line</span> <span class="o">&gt;=</span> <span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">m_line</span> <span class="o">&lt;=</span> <span class="n">bins</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">pdf_mass</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pdf_mass</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
                <span class="n">y_line</span> <span class="o">=</span> <span class="n">pdf_mass</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">*</span> <span class="n">ref_width</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">md</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">m_line</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">y_line</span><span class="p">,</span> <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                         <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Underlying PDF (counts)&#39;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Simulated PBH Mass (g)&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Count&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">title_prefix</span><span class="si">}</span><span class="s1"> — Mass Distribution &amp; PDF overlay&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_hist_lognormal</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">sigma_ln</span><span class="p">,</span> <span class="n">title_prefix</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Histogram + counts-scaled Log-normal PDF overlay (bigger figure).&quot;&quot;&quot;</span>
        <span class="n">md</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">md</span> <span class="o">=</span> <span class="n">md</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">md</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">md</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>  <span class="c1"># &lt;-- bigger now</span>
        <span class="k">if</span> <span class="n">md</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">md</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">==</span> <span class="n">md</span><span class="o">.</span><span class="n">max</span><span class="p">():</span>
            <span class="n">center</span> <span class="o">=</span> <span class="n">md</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">eps</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">center</span><span class="p">)</span><span class="o">*</span><span class="mf">1e-9</span> <span class="k">if</span> <span class="n">center</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">1e-9</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="n">center</span><span class="o">-</span><span class="n">eps</span><span class="p">,</span> <span class="n">center</span><span class="o">+</span><span class="n">eps</span><span class="p">),</span>
                                  <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;samples&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">q25</span><span class="p">,</span> <span class="n">q75</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">75</span><span class="p">])</span>
            <span class="n">iqr</span> <span class="o">=</span> <span class="n">q75</span> <span class="o">-</span> <span class="n">q25</span>
            <span class="k">if</span> <span class="n">iqr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">bw</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">iqr</span> <span class="o">*</span> <span class="n">md</span><span class="o">.</span><span class="n">size</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">k</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">md</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">md</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="n">bw</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">k</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">md</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;samples&#39;</span><span class="p">)</span>

        <span class="n">bin_widths</span> <span class="o">=</span> <span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ref_width</span>  <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">bin_widths</span><span class="p">))</span> <span class="k">if</span> <span class="n">bin_widths</span><span class="o">.</span><span class="n">size</span> <span class="k">else</span> <span class="mf">1.0</span>

        <span class="n">mu_eff</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">peak</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sigma_ln</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mu_eff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">peak</span><span class="p">)</span> <span class="o">+</span> <span class="n">sigma_ln</span><span class="o">**</span><span class="mi">2</span>

        <span class="k">if</span> <span class="n">mu_eff</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mlo_tail</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">mu_eff</span> <span class="o">-</span> <span class="mf">6.0</span><span class="o">*</span><span class="n">sigma_ln</span><span class="p">)</span>
            <span class="n">mhi_tail</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">mu_eff</span> <span class="o">+</span> <span class="mf">6.0</span><span class="o">*</span><span class="n">sigma_ln</span><span class="p">)</span>
            <span class="n">m_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mlo_tail</span><span class="p">)),</span>
                                 <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">mhi_tail</span><span class="p">)),</span>
                                 <span class="mi">2000</span><span class="p">)</span>
            <span class="n">pdf</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="n">m_plot</span><span class="o">*</span><span class="n">sigma_ln</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
                <span class="o">-</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">m_plot</span><span class="p">)</span><span class="o">-</span><span class="n">mu_eff</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sigma_ln</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">y_plot</span> <span class="o">=</span> <span class="n">pdf</span> <span class="o">*</span> <span class="n">ref_width</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">md</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">m_plot</span><span class="p">,</span> <span class="n">y_plot</span><span class="p">,</span> <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                     <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Underlying PDF (counts)&#39;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Simulated PBH Mass (g)&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Count&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">title_prefix</span><span class="si">}</span><span class="s1"> — Mass Distribution &amp; PDF overlay&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_hist_custom</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="n">title_prefix</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Histogram for a custom-equation run (size already large at 10×6 in generator).&quot;&quot;&quot;</span>
        <span class="n">spath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="s2">&quot;samples_sorted.txt&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">spath</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">samples</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">samples</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">expr</span><span class="p">,</span> <span class="n">user_vars</span> <span class="o">=</span> <span class="n">_read_equation_file</span><span class="p">(</span><span class="n">run_dir</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">user_vars</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">masses_all2</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">discover_mass_folders</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">masses_all2</span><span class="p">:</span>
            <span class="n">M_MIN</span><span class="p">,</span> <span class="n">M_MAX</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">masses_all2</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">masses_all2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">M_MIN</span><span class="p">,</span> <span class="n">M_MAX</span> <span class="o">=</span> <span class="mf">5e13</span><span class="p">,</span> <span class="mf">1e19</span>

        <span class="n">pdf</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">expr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">m_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">M_MIN</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">M_MAX</span><span class="p">),</span> <span class="mi">20000</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">_safe_eval_on_grid</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">m_grid</span><span class="p">,</span> <span class="n">user_vars</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">area</span> <span class="o">=</span> <span class="n">trapezoid</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">m_grid</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">area</span><span class="p">)</span> <span class="ow">and</span> <span class="n">area</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">pdf</span> <span class="o">=</span> <span class="n">f</span> <span class="o">/</span> <span class="n">area</span>

        <span class="n">N_BINS</span> <span class="o">=</span> <span class="mi">50</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">M_MIN</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">M_MAX</span><span class="p">),</span> <span class="n">N_BINS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">edges</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                 <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Sampled counts per bin (N=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pdf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dln</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">M_MAX</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">M_MIN</span><span class="p">))</span> <span class="o">/</span> <span class="n">N_BINS</span>
            <span class="n">counts_line</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span> <span class="o">*</span> <span class="n">pdf</span> <span class="o">*</span> <span class="n">m_grid</span> <span class="o">*</span> <span class="n">dln</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">m_grid</span><span class="p">,</span> <span class="n">counts_line</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Analytic PDF (scaled to counts)&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Mass m (g)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Count per bin&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">title_prefix</span><span class="si">}</span><span class="s2"> — Mass Histogram (counts) + Smooth PDF&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># ---------- UI ----------</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_print_menu</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">View Previous — choose:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; 1: Monochromatic Distribution&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; 2: </span><span class="si">{</span><span class="n">GAUSSIAN_METHOD</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; 3: </span><span class="si">{</span><span class="n">NON_GAUSSIAN_METHOD</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; 4: </span><span class="si">{</span><span class="n">LOGNORMAL_METHOD</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; 5: Custom equation (user-defined mass PDF)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; 0: Plot all Queued | b: Back | q: Quit&quot;</span><span class="p">)</span>

    <span class="c1"># queue elements:</span>
    <span class="n">queue</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Preload matrices/splines once for fast monochromatic interpolation in this view</span>
    <span class="n">mono_ready</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">mono_E</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sp_d</span> <span class="o">=</span> <span class="n">sp_s</span> <span class="o">=</span> <span class="n">sp_i</span> <span class="o">=</span> <span class="n">sp_f</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">logE</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">Emax_ifa</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">floor</span> <span class="o">=</span> <span class="mf">1e-300</span>
    <span class="n">N_M</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_ensure_mono_interpolator</span><span class="p">():</span>
        <span class="k">nonlocal</span> <span class="n">mono_ready</span><span class="p">,</span> <span class="n">mono_E</span><span class="p">,</span> <span class="n">sp_d</span><span class="p">,</span> <span class="n">sp_s</span><span class="p">,</span> <span class="n">sp_i</span><span class="p">,</span> <span class="n">sp_f</span><span class="p">,</span> <span class="n">logE</span><span class="p">,</span> <span class="n">Emax_ifa</span><span class="p">,</span> <span class="n">N_M</span>
        <span class="k">if</span> <span class="n">mono_ready</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">masses_all</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No valid mass folders found under data directory.&quot;</span><span class="p">)</span>
        <span class="n">first</span> <span class="o">=</span> <span class="n">load_spectra_components</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">,</span> <span class="n">names_all</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">mono_E</span> <span class="o">=</span> <span class="n">first</span><span class="p">[</span><span class="s1">&#39;energy_primary&#39;</span><span class="p">]</span>
        <span class="n">logE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">mono_E</span><span class="p">)</span>
        <span class="n">N_M</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">masses_all</span><span class="p">)</span>

        <span class="n">direct_mat</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N_M</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">mono_E</span><span class="p">)))</span>
        <span class="n">secondary_mat</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">direct_mat</span><span class="p">)</span>
        <span class="n">inflight_mat</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">direct_mat</span><span class="p">)</span>
        <span class="n">final_mat</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">direct_mat</span><span class="p">)</span>
        <span class="n">Emax_ifa</span>       <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N_M</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">masses_all</span><span class="p">):</span>
            <span class="n">sub</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">,</span> <span class="n">names_all</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">S</span> <span class="o">=</span> <span class="n">load_spectra_components</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>
            <span class="n">direct_mat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>    <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="s1">&#39;direct_gamma_primary&#39;</span><span class="p">]</span>
            <span class="n">secondary_mat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">mono_E</span><span class="p">,</span> <span class="n">S</span><span class="p">[</span><span class="s1">&#39;energy_secondary&#39;</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="s1">&#39;direct_gamma_secondary&#39;</span><span class="p">],</span> <span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">inflight_mat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="s1">&#39;IFA_primary&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">mono_E</span><span class="p">,</span> <span class="n">S</span><span class="p">[</span><span class="s1">&#39;energy_secondary&#39;</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="s1">&#39;IFA_secondary&#39;</span><span class="p">],</span> <span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">final_mat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>     <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="s1">&#39;FSR_primary&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">mono_E</span><span class="p">,</span> <span class="n">S</span><span class="p">[</span><span class="s1">&#39;energy_secondary&#39;</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="s1">&#39;FSR_secondary&#39;</span><span class="p">],</span> <span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">load_xy_lenient</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="s2">&quot;inflight_annihilation_prim.txt&quot;</span><span class="p">))</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">load_xy_lenient</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="s2">&quot;inflight_annihilation_sec.txt&quot;</span><span class="p">))</span>
            <span class="n">Emax_ifa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">p</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">size</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">size</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">logM_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">masses_all</span><span class="p">)</span>
        <span class="n">ld</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">direct_mat</span>    <span class="o">&gt;</span> <span class="n">floor</span><span class="p">,</span> <span class="n">direct_mat</span><span class="p">,</span>     <span class="n">floor</span><span class="p">))</span>
        <span class="n">ls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">secondary_mat</span> <span class="o">&gt;</span> <span class="n">floor</span><span class="p">,</span> <span class="n">secondary_mat</span><span class="p">,</span>  <span class="n">floor</span><span class="p">))</span>
        <span class="n">li</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">inflight_mat</span>  <span class="o">&gt;</span> <span class="n">floor</span><span class="p">,</span> <span class="n">inflight_mat</span><span class="p">,</span>   <span class="n">floor</span><span class="p">))</span>
        <span class="n">lf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">final_mat</span>     <span class="o">&gt;</span> <span class="n">floor</span><span class="p">,</span> <span class="n">final_mat</span><span class="p">,</span>      <span class="n">floor</span><span class="p">))</span>

        <span class="n">sp_d</span> <span class="o">=</span> <span class="n">RectBivariateSpline</span><span class="p">(</span><span class="n">logM_all</span><span class="p">,</span> <span class="n">logE</span><span class="p">,</span> <span class="n">ld</span><span class="p">,</span> <span class="n">kx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ky</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">sp_s</span> <span class="o">=</span> <span class="n">RectBivariateSpline</span><span class="p">(</span><span class="n">logM_all</span><span class="p">,</span> <span class="n">logE</span><span class="p">,</span> <span class="n">ls</span><span class="p">,</span> <span class="n">kx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ky</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">sp_i</span> <span class="o">=</span> <span class="n">RectBivariateSpline</span><span class="p">(</span><span class="n">logM_all</span><span class="p">,</span> <span class="n">logE</span><span class="p">,</span> <span class="n">li</span><span class="p">,</span> <span class="n">kx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ky</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">sp_f</span> <span class="o">=</span> <span class="n">RectBivariateSpline</span><span class="p">(</span><span class="n">logM_all</span><span class="p">,</span> <span class="n">logE</span><span class="p">,</span> <span class="n">lf</span><span class="p">,</span> <span class="n">kx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ky</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mono_ready</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">_print_menu</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">choice</span> <span class="o">=</span> <span class="n">user_input</span><span class="p">(</span><span class="s2">&quot;Choice: &quot;</span><span class="p">,</span> <span class="n">allow_back</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">allow_exit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">BackRequested</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># Handle feeders that don&#39;t raise BackRequested / SystemExit</span>
        <span class="k">if</span> <span class="n">choice</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;back&quot;</span><span class="p">):</span>
                    <span class="k">return</span>
        <span class="k">if</span> <span class="n">choice</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="s2">&quot;exit&quot;</span><span class="p">):</span>
            <span class="k">return</span>  <span class="c1"># don&#39;t sys.exit() here; returning keeps tests happy</span>

        <span class="c1"># ----- plot all queued -----</span>
        <span class="k">if</span> <span class="n">choice</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">queue</span><span class="p">:</span>
                <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Queue is empty.&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">plot_pack</span> <span class="o">=</span> <span class="p">[(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">],</span> <span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;E&#39;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]))</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">queue</span><span class="p">]</span>
            <span class="n">_plot_dn</span><span class="p">(</span><span class="n">plot_pack</span><span class="p">)</span>
            <span class="n">_plot_e2</span><span class="p">(</span><span class="n">plot_pack</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">queue</span><span class="p">:</span>
                <span class="n">h</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hist&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">h</span><span class="p">:</span>  <span class="c1"># monochromatic has no histogram</span>
                    <span class="k">continue</span>
                <span class="n">kind</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="s1">&#39;kind&#39;</span><span class="p">]</span>
                <span class="n">run_dir</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="s1">&#39;run_dir&#39;</span><span class="p">]</span>
                <span class="n">label_for_hist</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
                <span class="n">peak_val</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;peak&#39;</span><span class="p">)</span>
                <span class="n">sigma_val</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sigma&#39;</span><span class="p">)</span>  <span class="c1"># for non_gaussian this is sigma_X</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;gaussian&quot;</span><span class="p">,</span> <span class="s2">&quot;non_gaussian&quot;</span><span class="p">,</span> <span class="s2">&quot;lognormal&quot;</span><span class="p">):</span>
                        <span class="n">md_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="s2">&quot;mass_distribution.txt&quot;</span><span class="p">)</span>
                        <span class="n">md</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">md_path</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">:</span>
                            <span class="n">_hist_gaussian</span><span class="p">(</span><span class="n">md</span><span class="p">,</span>
                                           <span class="n">peak_val</span> <span class="k">if</span> <span class="n">peak_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">md</span><span class="p">),</span>
                                           <span class="n">sigma_val</span> <span class="k">if</span> <span class="n">sigma_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mf">0.05</span><span class="p">,</span>
                                           <span class="n">label_for_hist</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;non_gaussian&quot;</span><span class="p">:</span>
                            <span class="n">_hist_nongaussian</span><span class="p">(</span><span class="n">md</span><span class="p">,</span>
                                              <span class="n">peak_val</span> <span class="k">if</span> <span class="n">peak_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">md</span><span class="p">),</span>
                                              <span class="n">sigma_val</span> <span class="k">if</span> <span class="n">sigma_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mf">0.08</span><span class="p">,</span>
                                              <span class="n">label_for_hist</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>  <span class="c1"># lognormal</span>
                            <span class="n">_hist_lognormal</span><span class="p">(</span><span class="n">md</span><span class="p">,</span>
                                            <span class="n">peak_val</span> <span class="k">if</span> <span class="n">peak_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">md</span><span class="p">),</span>
                                            <span class="n">sigma_val</span> <span class="k">if</span> <span class="n">sigma_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mf">1.0</span><span class="p">,</span>
                                            <span class="n">label_for_hist</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;custom&quot;</span><span class="p">:</span>
                        <span class="n">_hist_custom</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="n">label_for_hist</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Histogram inputs missing in </span><span class="si">{</span><span class="n">run_dir</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Histogram reconstruction failed for </span><span class="si">{</span><span class="n">run_dir</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">queue</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">info</span><span class="p">(</span><span class="s2">&quot;Queue cleared.&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">choice</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cat_map</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Invalid choice; try again.&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">label_group</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">spec_file</span><span class="p">,</span> <span class="n">kind</span> <span class="o">=</span> <span class="n">cat_map</span><span class="p">[</span><span class="n">choice</span><span class="p">]</span>

        <span class="c1"># ----- NEW Monochromatic branch (no listing, no rounding; interpolate &amp; queue) -----</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;mono&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Enter PBH masses (g) to QUEUE for monochromatic plots (range [</span><span class="si">{</span><span class="n">M_MIN_MONO</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">M_MAX_MONO</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">]).&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mstr</span> <span class="o">=</span> <span class="n">user_input</span><span class="p">(</span><span class="s2">&quot;Masses (comma-separated): &quot;</span><span class="p">,</span> <span class="n">allow_back</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">allow_exit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">BackRequested</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">mstr</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># build interpolators once</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_ensure_mono_interpolator</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">err</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot prepare interpolator: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">req_masses</span> <span class="o">=</span> <span class="n">parse_float_list_verbose</span><span class="p">(</span>
                <span class="n">mstr</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;mass (g)&quot;</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="n">M_MIN_MONO</span><span class="p">,</span> <span class="n">M_MAX_MONO</span><span class="p">),</span> <span class="n">allow_empty</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">req_masses</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">mval</span> <span class="ow">in</span> <span class="n">req_masses</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># no snapping: always interpolate in (logM, logE)</span>
                    <span class="n">idx_up</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">masses_all</span><span class="p">,</span> <span class="n">mval</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">))</span>
                    <span class="n">idx_low</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">idx_up</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">idx_up</span>  <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">idx_up</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">masses_all</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">Ecut</span>    <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">Emax_ifa</span><span class="p">[</span><span class="n">idx_low</span><span class="p">],</span> <span class="n">Emax_ifa</span><span class="p">[</span><span class="n">idx_up</span><span class="p">])</span>
                    <span class="n">logm</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">mval</span><span class="p">)</span>
                    <span class="n">d_vals</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">sp_d</span><span class="p">(</span><span class="n">logm</span><span class="p">,</span> <span class="n">logE</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
                    <span class="n">s_vals</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">sp_s</span><span class="p">(</span><span class="n">logm</span><span class="p">,</span> <span class="n">logE</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
                    <span class="n">i_vals</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">sp_i</span><span class="p">(</span><span class="n">logm</span><span class="p">,</span> <span class="n">logE</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
                    <span class="n">f_vals</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">sp_f</span><span class="p">(</span><span class="n">logm</span><span class="p">,</span> <span class="n">logE</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
                    <span class="c1"># guard inflight tails</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">i_vals</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">i_vals</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">i_vals</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">):</span> <span class="n">i_vals</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="k">else</span><span class="p">:</span> <span class="k">break</span>
                    <span class="n">log10i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">i_vals</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="n">i_vals</span><span class="p">,</span> <span class="n">floor</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">log10i</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="n">log10i</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">log10i</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">50</span><span class="p">:</span>
                            <span class="n">i_vals</span><span class="p">[</span><span class="n">j</span><span class="p">:]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span> <span class="k">break</span>
                    <span class="n">i_vals</span><span class="p">[</span><span class="n">mono_E</span> <span class="o">&gt;=</span> <span class="n">Ecut</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="n">T</span> <span class="o">=</span> <span class="n">d_vals</span> <span class="o">+</span> <span class="n">s_vals</span> <span class="o">+</span> <span class="n">i_vals</span> <span class="o">+</span> <span class="n">f_vals</span>
                    <span class="n">T</span><span class="p">[</span><span class="n">T</span> <span class="o">&lt;</span> <span class="mf">1e-299</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

                    <span class="n">queue</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Monochromatic </span><span class="si">{</span><span class="n">mval</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> g (interp)&quot;</span><span class="p">,</span>
                        <span class="s1">&#39;E&#39;</span><span class="p">:</span> <span class="n">mono_E</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                        <span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="n">T</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                        <span class="s1">&#39;hist&#39;</span><span class="p">:</span> <span class="kc">None</span>
                    <span class="p">})</span>
                    <span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Queued Monochromatic </span><span class="si">{</span><span class="n">mval</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> g (interpolated)&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to queue </span><span class="si">{</span><span class="n">mval</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> g: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># ----- Distributed branches (unchanged, except bigger hist funcs will be used later) -----</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">subdirs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">root</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span>
            <span class="p">]</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="n">subdirs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Pretty listing entries</span>
        <span class="n">pretty_entries</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">subdirs</span><span class="p">:</span>
            <span class="n">peak_val</span><span class="p">,</span> <span class="n">sigma_val</span><span class="p">,</span> <span class="n">sigma_str</span> <span class="o">=</span> <span class="n">_extract_peak_sigma</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">kind</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">:</span>
                <span class="n">pretty</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">GAUSSIAN_METHOD</span><span class="si">}</span><span class="s2"> peak </span><span class="si">{</span><span class="n">peak_val</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> g (</span><span class="si">{</span><span class="n">sigma_str</span><span class="si">}</span><span class="s2">)&quot;</span>
                          <span class="k">if</span> <span class="p">(</span><span class="n">peak_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sigma_str</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">GAUSSIAN_METHOD</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;non_gaussian&quot;</span><span class="p">:</span>
                <span class="n">pretty</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">NON_GAUSSIAN_METHOD</span><span class="si">}</span><span class="s2"> peak </span><span class="si">{</span><span class="n">peak_val</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> g (</span><span class="si">{</span><span class="n">sigma_str</span><span class="si">}</span><span class="s2">)&quot;</span>
                          <span class="k">if</span> <span class="p">(</span><span class="n">peak_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sigma_str</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">NON_GAUSSIAN_METHOD</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;lognormal&quot;</span><span class="p">:</span>
                <span class="n">pretty</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">LOGNORMAL_METHOD</span><span class="si">}</span><span class="s2"> peak </span><span class="si">{</span><span class="n">peak_val</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> g (</span><span class="si">{</span><span class="n">sigma_str</span><span class="si">}</span><span class="s2">)&quot;</span>
                          <span class="k">if</span> <span class="p">(</span><span class="n">peak_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sigma_str</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">LOGNORMAL_METHOD</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;custom&quot;</span><span class="p">:</span>
                <span class="n">pretty</span> <span class="o">=</span> <span class="n">d</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pretty</span> <span class="o">=</span> <span class="n">d</span>
            <span class="n">pretty_entries</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">d</span><span class="p">,</span> <span class="n">pretty</span><span class="p">,</span> <span class="n">peak_val</span><span class="p">,</span> <span class="n">sigma_val</span><span class="p">))</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Available in </span><span class="si">{</span><span class="n">label_group</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">pretty</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pretty_entries</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">pretty</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">sel</span> <span class="o">=</span> <span class="n">user_input</span><span class="p">(</span>
            <span class="s2">&quot;Enter indices to QUEUE (comma-separated): &quot;</span><span class="p">,</span>
            <span class="n">allow_back</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">allow_exit</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sel</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">idxs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sel</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Invalid indices input.&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">for</span> <span class="n">i_sel</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">i_sel</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pretty_entries</span><span class="p">)):</span>
                <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Index </span><span class="si">{</span><span class="n">i_sel</span><span class="si">}</span><span class="s2"> out of range.&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">run_name</span><span class="p">,</span> <span class="n">pretty_label</span><span class="p">,</span> <span class="n">peak_val</span><span class="p">,</span> <span class="n">sigma_val</span> <span class="o">=</span> <span class="n">pretty_entries</span><span class="p">[</span><span class="n">i_sel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">run_dir</span>  <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">run_name</span><span class="p">)</span>
            <span class="n">spec_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="n">spec_file</span><span class="p">)</span> <span class="k">if</span> <span class="n">spec_file</span> <span class="k">else</span> <span class="kc">None</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">spec_path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">spec_path</span><span class="p">):</span>
                    <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">spec_path</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">arr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">E</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">S</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">:</span>
                            <span class="n">plot_label</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">GAUSSIAN_METHOD</span><span class="si">}</span><span class="s2"> peak </span><span class="si">{</span><span class="n">peak_val</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> g (σ=</span><span class="si">{</span><span class="n">sigma_val</span><span class="si">:</span><span class="s2">.3g</span><span class="si">}</span><span class="s2">)&quot;</span>
                                          <span class="k">if</span> <span class="n">peak_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sigma_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span>
                                          <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">GAUSSIAN_METHOD</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">run_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;non_gaussian&quot;</span><span class="p">:</span>
                            <span class="n">plot_label</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">NON_GAUSSIAN_METHOD</span><span class="si">}</span><span class="s2"> peak </span><span class="si">{</span><span class="n">peak_val</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> g (σX=</span><span class="si">{</span><span class="n">sigma_val</span><span class="si">:</span><span class="s2">.3g</span><span class="si">}</span><span class="s2">)&quot;</span>
                                          <span class="k">if</span> <span class="n">peak_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sigma_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span>
                                          <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">NON_GAUSSIAN_METHOD</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">run_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;lognormal&quot;</span><span class="p">:</span>
                            <span class="n">plot_label</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">LOGNORMAL_METHOD</span><span class="si">}</span><span class="s2"> peak </span><span class="si">{</span><span class="n">peak_val</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> g (σ=</span><span class="si">{</span><span class="n">sigma_val</span><span class="si">:</span><span class="s2">.3g</span><span class="si">}</span><span class="s2">)&quot;</span>
                                          <span class="k">if</span> <span class="n">peak_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sigma_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span>
                                          <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">LOGNORMAL_METHOD</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">run_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;custom&quot;</span><span class="p">:</span>
                            <span class="n">plot_label</span> <span class="o">=</span> <span class="n">run_name</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">plot_label</span> <span class="o">=</span> <span class="n">run_name</span>

                        <span class="n">queue</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">plot_label</span><span class="p">,</span>
                            <span class="s1">&#39;E&#39;</span><span class="p">:</span> <span class="n">E</span><span class="p">,</span>
                            <span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="n">S</span><span class="p">,</span>
                            <span class="s1">&#39;hist&#39;</span><span class="p">:</span> <span class="p">{</span>
                                <span class="s1">&#39;kind&#39;</span><span class="p">:</span> <span class="n">kind</span><span class="p">,</span>
                                <span class="s1">&#39;run_dir&#39;</span><span class="p">:</span> <span class="n">run_dir</span><span class="p">,</span>
                                <span class="s1">&#39;peak&#39;</span><span class="p">:</span> <span class="n">peak_val</span><span class="p">,</span>
                                <span class="s1">&#39;sigma&#39;</span><span class="p">:</span> <span class="n">sigma_val</span>
                            <span class="p">}</span>
                        <span class="p">})</span>
                        <span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Queued </span><span class="si">{</span><span class="n">plot_label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">spec_file</span><span class="si">}</span><span class="s2"> malformed in </span><span class="si">{</span><span class="n">run_name</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No &#39;</span><span class="si">{</span><span class="n">spec_file</span><span class="si">}</span><span class="s2">&#39; found in </span><span class="si">{</span><span class="n">run_name</span><span class="si">}</span><span class="s2">; skipping queue.&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to queue </span><span class="si">{</span><span class="n">run_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># ---------- UI ----------</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_print_menu</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">View Previous — choose:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; 1: Monochromatic Distribution&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; 2: </span><span class="si">{</span><span class="n">GAUSSIAN_METHOD</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; 3: </span><span class="si">{</span><span class="n">NON_GAUSSIAN_METHOD</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; 4: </span><span class="si">{</span><span class="n">LOGNORMAL_METHOD</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; 5: Custom equation (user-defined mass PDF)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; 0: Plot all Queued | b: Back | q: Quit&quot;</span><span class="p">)</span>

    <span class="c1"># queue elements:</span>
    <span class="c1"># {</span>
    <span class="c1">#    &#39;label&#39;: str (pretty label for overlay / hist title),</span>
    <span class="c1">#    &#39;E&#39;: ndarray,</span>
    <span class="c1">#    &#39;S&#39;: ndarray,</span>
    <span class="c1">#    &#39;hist&#39;: {&#39;kind&#39;: kind, &#39;run_dir&#39;: run_dir, &#39;peak&#39;: float?, &#39;sigma&#39;: float?} or None</span>
    <span class="c1"># }</span>
    <span class="n">queue</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">_print_menu</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">choice</span> <span class="o">=</span> <span class="n">user_input</span><span class="p">(</span><span class="s2">&quot;Choice: &quot;</span><span class="p">,</span> <span class="n">allow_back</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">allow_exit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">BackRequested</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># ----- plot all queued -----</span>
        <span class="k">if</span> <span class="n">choice</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">queue</span><span class="p">:</span>
                <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Queue is empty.&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># spectra first</span>
            <span class="n">plot_pack</span> <span class="o">=</span> <span class="p">[(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">],</span> <span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;E&#39;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]))</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">queue</span><span class="p">]</span>
            <span class="n">_plot_dn</span><span class="p">(</span><span class="n">plot_pack</span><span class="p">)</span>
            <span class="n">_plot_e2</span><span class="p">(</span><span class="n">plot_pack</span><span class="p">)</span>

            <span class="c1"># histograms second</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">queue</span><span class="p">:</span>
                <span class="n">h</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hist&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">h</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">kind</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="s1">&#39;kind&#39;</span><span class="p">]</span>
                <span class="n">run_dir</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="s1">&#39;run_dir&#39;</span><span class="p">]</span>
                <span class="n">label_for_hist</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
                <span class="n">peak_val</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;peak&#39;</span><span class="p">)</span>
                <span class="n">sigma_val</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sigma&#39;</span><span class="p">)</span>  <span class="c1"># for non_gaussian this is sigma_X</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;gaussian&quot;</span><span class="p">,</span> <span class="s2">&quot;non_gaussian&quot;</span><span class="p">,</span> <span class="s2">&quot;lognormal&quot;</span><span class="p">):</span>
                        <span class="n">md_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="s2">&quot;mass_distribution.txt&quot;</span><span class="p">)</span>
                        <span class="n">md</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">md_path</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">:</span>
                            <span class="n">_hist_gaussian</span><span class="p">(</span><span class="n">md</span><span class="p">,</span>
                                           <span class="n">peak_val</span> <span class="k">if</span> <span class="n">peak_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">md</span><span class="p">),</span>
                                           <span class="n">sigma_val</span> <span class="k">if</span> <span class="n">sigma_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mf">0.05</span><span class="p">,</span>
                                           <span class="n">label_for_hist</span><span class="p">)</span>

                        <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;non_gaussian&quot;</span><span class="p">:</span>
                            <span class="n">_hist_nongaussian</span><span class="p">(</span><span class="n">md</span><span class="p">,</span>
                                              <span class="n">peak_val</span> <span class="k">if</span> <span class="n">peak_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">md</span><span class="p">),</span>
                                              <span class="n">sigma_val</span> <span class="k">if</span> <span class="n">sigma_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mf">0.08</span><span class="p">,</span>
                                              <span class="n">label_for_hist</span><span class="p">)</span>

                        <span class="k">else</span><span class="p">:</span>  <span class="c1"># lognormal</span>
                            <span class="n">_hist_lognormal</span><span class="p">(</span><span class="n">md</span><span class="p">,</span>
                                            <span class="n">peak_val</span> <span class="k">if</span> <span class="n">peak_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">md</span><span class="p">),</span>
                                            <span class="n">sigma_val</span> <span class="k">if</span> <span class="n">sigma_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mf">1.0</span><span class="p">,</span>
                                            <span class="n">label_for_hist</span><span class="p">)</span>

                    <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;custom&quot;</span><span class="p">:</span>
                        <span class="n">_hist_custom</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="n">label_for_hist</span><span class="p">)</span>

                <span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Histogram inputs missing in </span><span class="si">{</span><span class="n">run_dir</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Histogram reconstruction failed for </span><span class="si">{</span><span class="n">run_dir</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># clear queue</span>
            <span class="n">queue</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">info</span><span class="p">(</span><span class="s2">&quot;Queue cleared.&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">choice</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cat_map</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Invalid choice; try again.&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">label_group</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">spec_file</span><span class="p">,</span> <span class="n">kind</span> <span class="o">=</span> <span class="n">cat_map</span><span class="p">[</span><span class="n">choice</span><span class="p">]</span>

        <span class="c1"># ----- Monochromatic branch -----</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;mono&quot;</span><span class="p">:</span>
            <span class="n">runs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">root</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">fn</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.txt&quot;</span><span class="p">):</span>
                        <span class="n">runs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="n">fn</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Available in </span><span class="si">{</span><span class="n">label_group</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,(</span><span class="n">_</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">runs</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">You can also request a target mass (in grams) to generate the nearest pre-rendered mono spectrum.&quot;</span><span class="p">)</span>
            <span class="n">sel</span> <span class="o">=</span> <span class="n">user_input</span><span class="p">(</span>
                <span class="s2">&quot;Enter indices to QUEUE (comma-separated) OR a mass (e.g. 1e15), or Enter to cancel: &quot;</span><span class="p">,</span>
                <span class="n">allow_back</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">allow_exit</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">sel</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># numeric mass path?</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mass_try</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">mass_try</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">mass_try</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">M_MIN_MONO</span> <span class="o">&lt;=</span> <span class="n">mass_try</span> <span class="o">&lt;=</span> <span class="n">M_MAX_MONO</span><span class="p">):</span>
                    <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mass outside allowed view window [</span><span class="si">{</span><span class="n">M_MIN_MONO</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">M_MAX_MONO</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">].&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fname</span> <span class="o">=</span> <span class="n">generate_monochromatic_for_mass</span><span class="p">(</span><span class="n">mass_try</span><span class="p">,</span> <span class="n">DATA_DIR</span><span class="p">,</span> <span class="n">MONO_RESULTS_DIR</span><span class="p">)</span>
                    <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                    <span class="n">E</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">T</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">queue</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Monochromatic </span><span class="si">{</span><span class="n">mass_try</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> g&quot;</span><span class="p">,</span>
                        <span class="s1">&#39;E&#39;</span><span class="p">:</span> <span class="n">E</span><span class="p">,</span>
                        <span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span>
                        <span class="s1">&#39;hist&#39;</span><span class="p">:</span> <span class="kc">None</span>
                    <span class="p">})</span>
                    <span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Queued Monochromatic </span><span class="si">{</span><span class="n">mass_try</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> g → </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">err</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not generate/queue mono spectrum: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># index list path</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">idxs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sel</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Invalid indices input.&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">:</span>
                <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">runs</span><span class="p">):</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">fn</span> <span class="o">=</span> <span class="n">runs</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                        <span class="n">E</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">T</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">arr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">E</span><span class="p">)</span>
                        <span class="n">queue</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Monochromatic </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="s1">&#39;E&#39;</span>   <span class="p">:</span> <span class="n">E</span><span class="p">,</span>
                            <span class="s1">&#39;S&#39;</span>   <span class="p">:</span> <span class="n">T</span><span class="p">,</span>
                            <span class="s1">&#39;hist&#39;</span><span class="p">:</span> <span class="kc">None</span>
                        <span class="p">})</span>
                        <span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Queued </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to read </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># ----- Distributed branches -----</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">subdirs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">root</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span>
            <span class="p">]</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="n">subdirs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Build pretty listing entries</span>
        <span class="n">pretty_entries</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">subdirs</span><span class="p">:</span>
            <span class="n">peak_val</span><span class="p">,</span> <span class="n">sigma_val</span><span class="p">,</span> <span class="n">sigma_str</span> <span class="o">=</span> <span class="n">_extract_peak_sigma</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">kind</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">peak_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sigma_str</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">pretty</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">GAUSSIAN_METHOD</span><span class="si">}</span><span class="s2"> peak </span><span class="si">{</span><span class="n">peak_val</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> g (</span><span class="si">{</span><span class="n">sigma_str</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pretty</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">GAUSSIAN_METHOD</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;non_gaussian&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">peak_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sigma_str</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">pretty</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">NON_GAUSSIAN_METHOD</span><span class="si">}</span><span class="s2"> peak </span><span class="si">{</span><span class="n">peak_val</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> g (</span><span class="si">{</span><span class="n">sigma_str</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pretty</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">NON_GAUSSIAN_METHOD</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;lognormal&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">peak_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sigma_str</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">pretty</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">LOGNORMAL_METHOD</span><span class="si">}</span><span class="s2"> peak </span><span class="si">{</span><span class="n">peak_val</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> g (</span><span class="si">{</span><span class="n">sigma_str</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pretty</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">LOGNORMAL_METHOD</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;custom&quot;</span><span class="p">:</span>
                <span class="c1"># Just show folder name (no equation)</span>
                <span class="n">pretty</span> <span class="o">=</span> <span class="n">d</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">pretty</span> <span class="o">=</span> <span class="n">d</span>

            <span class="n">pretty_entries</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">d</span><span class="p">,</span> <span class="n">pretty</span><span class="p">,</span> <span class="n">peak_val</span><span class="p">,</span> <span class="n">sigma_val</span><span class="p">))</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Available in </span><span class="si">{</span><span class="n">label_group</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">pretty</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pretty_entries</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">pretty</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">sel</span> <span class="o">=</span> <span class="n">user_input</span><span class="p">(</span>
            <span class="s2">&quot;Enter indices to QUEUE (comma-separated): &quot;</span><span class="p">,</span>
            <span class="n">allow_back</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">allow_exit</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sel</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">idxs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sel</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Invalid indices input.&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">for</span> <span class="n">i_sel</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">i_sel</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pretty_entries</span><span class="p">)):</span>
                <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Index </span><span class="si">{</span><span class="n">i_sel</span><span class="si">}</span><span class="s2"> out of range.&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">run_name</span><span class="p">,</span> <span class="n">pretty_label</span><span class="p">,</span> <span class="n">peak_val</span><span class="p">,</span> <span class="n">sigma_val</span> <span class="o">=</span> <span class="n">pretty_entries</span><span class="p">[</span><span class="n">i_sel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">run_dir</span>  <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">run_name</span><span class="p">)</span>
            <span class="n">spec_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="n">spec_file</span><span class="p">)</span> <span class="k">if</span> <span class="n">spec_file</span> <span class="k">else</span> <span class="kc">None</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">spec_path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">spec_path</span><span class="p">):</span>
                    <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">spec_path</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">arr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">E</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">S</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>

                        <span class="c1"># Build final label for plots:</span>
                        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">peak_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sigma_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">plot_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">GAUSSIAN_METHOD</span><span class="si">}</span><span class="s2"> peak </span><span class="si">{</span><span class="n">peak_val</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> g (σ=</span><span class="si">{</span><span class="n">sigma_val</span><span class="si">:</span><span class="s2">.3g</span><span class="si">}</span><span class="s2">)&quot;</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">plot_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">GAUSSIAN_METHOD</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">run_name</span><span class="si">}</span><span class="s2">&quot;</span>

                        <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;non_gaussian&quot;</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">peak_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sigma_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">plot_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">NON_GAUSSIAN_METHOD</span><span class="si">}</span><span class="s2"> peak </span><span class="si">{</span><span class="n">peak_val</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> g (σX=</span><span class="si">{</span><span class="n">sigma_val</span><span class="si">:</span><span class="s2">.3g</span><span class="si">}</span><span class="s2">)&quot;</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">plot_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">NON_GAUSSIAN_METHOD</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">run_name</span><span class="si">}</span><span class="s2">&quot;</span>

                        <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;lognormal&quot;</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">peak_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sigma_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">plot_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">LOGNORMAL_METHOD</span><span class="si">}</span><span class="s2"> peak </span><span class="si">{</span><span class="n">peak_val</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> g (σ=</span><span class="si">{</span><span class="n">sigma_val</span><span class="si">:</span><span class="s2">.3g</span><span class="si">}</span><span class="s2">)&quot;</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">plot_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">LOGNORMAL_METHOD</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">run_name</span><span class="si">}</span><span class="s2">&quot;</span>

                        <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;custom&quot;</span><span class="p">:</span>
                            <span class="n">plot_label</span> <span class="o">=</span> <span class="n">run_name</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">plot_label</span> <span class="o">=</span> <span class="n">run_name</span>

                        <span class="n">queue</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">plot_label</span><span class="p">,</span>
                            <span class="s1">&#39;E&#39;</span><span class="p">:</span> <span class="n">E</span><span class="p">,</span>
                            <span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="n">S</span><span class="p">,</span>
                            <span class="s1">&#39;hist&#39;</span><span class="p">:</span> <span class="p">{</span>
                                <span class="s1">&#39;kind&#39;</span><span class="p">:</span> <span class="n">kind</span><span class="p">,</span>
                                <span class="s1">&#39;run_dir&#39;</span><span class="p">:</span> <span class="n">run_dir</span><span class="p">,</span>
                                <span class="s1">&#39;peak&#39;</span><span class="p">:</span> <span class="n">peak_val</span><span class="p">,</span>
                                <span class="s1">&#39;sigma&#39;</span><span class="p">:</span> <span class="n">sigma_val</span>
                            <span class="p">}</span>
                        <span class="p">})</span>
                        <span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Queued </span><span class="si">{</span><span class="n">plot_label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">spec_file</span><span class="si">}</span><span class="s2"> malformed in </span><span class="si">{</span><span class="n">run_name</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No &#39;</span><span class="si">{</span><span class="n">spec_file</span><span class="si">}</span><span class="s2">&#39; found in </span><span class="si">{</span><span class="n">run_name</span><span class="si">}</span><span class="s2">; skipping queue.&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to queue </span><span class="si">{</span><span class="n">run_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<span class="c1"># ---------------------------</span>
<span class="c1"># UI</span>
<span class="c1"># ---------------------------</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">colorama</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fore</span><span class="p">,</span> <span class="n">Style</span><span class="p">,</span> <span class="n">init</span> <span class="k">as</span> <span class="n">colorama_init</span>
<span class="n">colorama_init</span><span class="p">(</span><span class="n">autoreset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="show_start_screen">
<a class="viewcode-back" href="../../api/generated/gammapbh.cli.html#gammapbh.cli.show_start_screen">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">show_start_screen</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Print the program banner and helpful usage hints.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">width</span> <span class="o">=</span> <span class="mi">56</span>  <span class="c1"># inner width of the box</span>
    <span class="n">top</span> <span class="o">=</span> <span class="s2">&quot;╔&quot;</span> <span class="o">+</span> <span class="s2">&quot;═&quot;</span> <span class="o">*</span> <span class="n">width</span> <span class="o">+</span> <span class="s2">&quot;╗&quot;</span>
    <span class="n">bot</span> <span class="o">=</span> <span class="s2">&quot;╚&quot;</span> <span class="o">+</span> <span class="s2">&quot;═&quot;</span> <span class="o">*</span> <span class="n">width</span> <span class="o">+</span> <span class="s2">&quot;╝&quot;</span>
    <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;GammaPBHPlotter: PBH Spectrum Tool&quot;</span>
    <span class="n">ver</span>   <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Version </span><span class="si">{</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">Fore</span><span class="o">.</span><span class="n">CYAN</span> <span class="o">+</span> <span class="n">Style</span><span class="o">.</span><span class="n">BRIGHT</span> <span class="o">+</span> <span class="n">top</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>        <span class="n">Fore</span><span class="o">.</span><span class="n">CYAN</span> <span class="o">+</span> <span class="n">Style</span><span class="o">.</span><span class="n">BRIGHT</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;║</span><span class="si">{</span><span class="n">title</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">width</span><span class="p">)</span><span class="si">}</span><span class="s2">║&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>        <span class="n">Fore</span><span class="o">.</span><span class="n">CYAN</span> <span class="o">+</span> <span class="n">Style</span><span class="o">.</span><span class="n">BRIGHT</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;║</span><span class="si">{</span><span class="n">ver</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">width</span><span class="p">)</span><span class="si">}</span><span class="s2">║&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>        <span class="n">Fore</span><span class="o">.</span><span class="n">CYAN</span> <span class="o">+</span> <span class="n">Style</span><span class="o">.</span><span class="n">BRIGHT</span> <span class="o">+</span> <span class="n">bot</span> <span class="o">+</span> <span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Analyze and visualize Hawking radiation spectra of primordial black holes.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">Fore</span><span class="o">.</span><span class="n">YELLOW</span> <span class="o">+</span> <span class="s2">&quot;📄 Associated Publication:&quot;</span> <span class="o">+</span> <span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   John Carlini &amp; Ilias Cholis — Particle Astrophysics Research</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;At any prompt: &#39;b&#39; = back, &#39;q&#39; = quit.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="main">
<a class="viewcode-back" href="../../api/generated/gammapbh.cli.html#gammapbh.cli.main">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Entry point for the interactive CLI loop.</span>

<span class="sd">    Menu</span>
<span class="sd">    ----</span>
<span class="sd">    1: Monochromatic spectra</span>
<span class="sd">    2: Distributed spectra (Gaussian collapse)</span>
<span class="sd">    3: Distributed spectra (Non-Gaussian Collapse)</span>
<span class="sd">    4: Distributed spectra (Log-Normal Distribution)</span>
<span class="sd">    5: Distributed spectra (Custom mass PDF)</span>
<span class="sd">    6: View previous spectra</span>
<span class="sd">    0: Exit</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">show_start_screen</span><span class="p">()</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Select:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;1: Monochromatic spectra&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;2: Distributed spectra (</span><span class="si">{</span><span class="n">GAUSSIAN_METHOD</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;3: Distributed spectra (</span><span class="si">{</span><span class="n">NON_GAUSSIAN_METHOD</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;4: Distributed spectra (</span><span class="si">{</span><span class="n">LOGNORMAL_METHOD</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;5: Distributed spectra (Custom mass PDF)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;6: View previous spectra&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;0: Exit&quot;</span><span class="p">)</span>
        <span class="n">choice</span> <span class="o">=</span> <span class="n">user_input</span><span class="p">(</span><span class="s2">&quot;Choice: &quot;</span><span class="p">,</span> <span class="n">allow_back</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">allow_exit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">choice</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>
            <span class="n">monochromatic_spectra</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="s1">&#39;2&#39;</span><span class="p">:</span>
            <span class="n">distributed_spectrum</span><span class="p">(</span><span class="n">GAUSSIAN_METHOD</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="s1">&#39;3&#39;</span><span class="p">:</span>
            <span class="n">distributed_spectrum</span><span class="p">(</span><span class="n">NON_GAUSSIAN_METHOD</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="s1">&#39;4&#39;</span><span class="p">:</span>
            <span class="n">distributed_spectrum</span><span class="p">(</span><span class="n">LOGNORMAL_METHOD</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="s1">&#39;5&#39;</span><span class="p">:</span>
            <span class="n">custom_equation_pdf_tool</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="s1">&#39;6&#39;</span><span class="p">:</span>
            <span class="n">view_previous_spectra</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">choice</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;0&#39;</span><span class="p">,</span><span class="s1">&#39;exit&#39;</span><span class="p">,</span><span class="s1">&#39;q&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Goodbye.&quot;</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid; try again.&quot;</span><span class="p">)</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">main</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">BackRequested</span><span class="p">:</span>
        <span class="c1"># If a BackRequested was thrown at the top-level, just exit cleanly.</span>
        <span class="k">pass</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">An error occurred. Press Enter to exit…&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=46bd48cc"></script>
    </body>
</html>